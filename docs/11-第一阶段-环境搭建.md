# 第一阶段：MVP量化开发环境搭建 (WSL版)

> **目标**: 建立最小可行 Rust+Python 量化开发环境
> **预计时间**: 1-2小时
> **提交标记**: `first-commit`
> **开发环境**: WSL2 + Ubuntu + Python虚拟环境
> **设计理念**: 精简启动，逐步迭代

## 📋 步骤概览

1. [✅] 基础环境检查
2. [ ] Rust 环境配置
3. [ ] Python 环境配置 (使用现有.venv)
4. [ ] 创建项目结构
5. [ ] 安装核心依赖
6. [ ] 基础配置和测试

---

## 步骤 1: 基础环境检查

### 1.1 当前环境状态
- ✅ **WSL2 + Ubuntu** (当前环境)
- ✅ **Python 3.11.14** - 已安装
- ✅ **Rust 1.90.0** - 已安装
- ✅ **.venv 虚拟环境** - 已创建

### 1.2 最小硬件要求
- **内存**: 8GB+ (推荐 16GB)
- **存储**: 20GB+ 可用空间
- **CPU**: 4核+ (推荐 8核)

### 1.3 快速检查
```bash
python3 -m venv venv
# 检查当前环境
python --version  # 应该显示 Python 3.11.14
rustc --version   # 应该显示 rustc 1.90.0
cargo --version
git --version

# 检查虚拟环境
ls -la .venv/     # 确认虚拟环境目录存在
```

---

## 步骤 2: Rust 环境配置

### 2.1 检查 Rust 环境
✅ **Rust 1.90.0 已安装**，只需要安装必要的开发工具：

```bash
# 检查当前版本
rustc --version
cargo --version

# 安装必要工具
rustup component add rustfmt clippy
cargo install cargo-watch     # 自动重新编译
cargo install --locked maturin      # Python Rust 混合开发工具
```

### 2.2 配置 Cargo 加速 (可选)
```bash
# 创建配置文件
mkdir -p ~/.cargo
cat > ~/.cargo/config.toml << 'EOF'
[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"
EOF
```

---

## 步骤 3: Python 环境配置

### 3.1 激活虚拟环境
```bash
# 确保在项目根目录
pwd  # 应该显示 /home/jackluo/PulseTrader

# 激活现有虚拟环境
source .venv/bin/activate

# 验证激活状态
which python      # 应该显示: /home/jackluo/PulseTrader/.venv/bin/python
python --version  # 应该显示: Python 3.11.14
```

### 3.2 安装 Poetry (如果未安装)
```bash
# 检查 Poetry 是否已安装
poetry --version

# 如果未安装，使用官方脚本安装：
curl -sSL https://install.python-poetry.org | python3 -

# 添加 Poetry 到 PATH (如果需要)
export PATH="$HOME/.local/bin:$PATH"
```

### 3.3 创建 pyproject.toml 配置文件
```bash
# 确保在项目根目录
pwd  # 应该显示 /home/jackluo/PulseTrader

# 使用 Poetry 初始化项目 (推荐)
poetry init

# 交互式配置示例：
# Package name [pulse-trader]: pulse-trader
# Version [0.1.0]: 0.1.0
# Description []: A股量化交易系统
# Author [Your Name <your.email@example.com>, n to skip]: Your Name <your.email@example.com>
# License []: MIT
# Compatible Python versions [^3.11]: ^3.11
#
# Would you like to define your main dependencies interactively? (yes/no) [yes] no
# Would you like to define your development dependencies interactively? (yes/no) [yes] no
#
# Generated file content will be shown，confirm? (yes/no) [yes] yes

# 或者使用快速创建命令 (非交互式)
cat > pyproject.toml << 'EOF'
[tool.poetry]
name = "pulse-trader"
version = "0.1.0"
description = "A股量化交易系统"
authors = ["Your Name <your.email@example.com>"]
# 关键配置：指定要包含的包目录
packages = [{include = "pulse_trader"}]

[tool.poetry.dependencies]
python = "^3.11"

[tool.poetry.group.dev.dependencies]
maturin = "^1.4.0"

[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"

# Black 代码格式化配置
[tool.black]
line-length = 88
target-version = ['py311']
EOF

# 重要提示：如果使用 poetry init 生成的配置，请确保：
# 1. 添加 packages = [{include = "pulse_trader"}] 配置
# 2. 将 [build-system] 的 build-backend 改为 "poetry.core.masonry.api"
# 3. 如果配置文件格式冲突，运行 poetry lock 重新生成锁文件
```

### 3.4 配置 Poetry 使用现有环境
```bash
# 配置 Poetry 使用现有的 .venv 虚拟环境
poetry config virtualenvs.in-project true
poetry config virtualenvs.create false

# 配置国内镜像源 (提高下载速度)
poetry source add --priority=primary tsinghua https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 3.5 创建 Python 包结构
```bash
# 在安装项目之前，需要先创建包目录结构
# Python 包目录
mkdir -p pulse_trader/{strategies,backtest,analysis,utils}

# 创建 Python 包的 __init__.py 文件
touch pulse_trader/__init__.py
touch pulse_trader/strategies/__init__.py
touch pulse_trader/backtest/__init__.py
touch pulse_trader/analysis/__init__.py
touch pulse_trader/utils/__init__.py

# 验证包结构
ls -la pulse_trader/
```

### 3.6 安装核心依赖 (MVP版本)
```bash
# 安装最小必要依赖
poetry add pandas numpy
poetry add maturin               # Python Rust 混合开发
poetry add tushare akshare pytdx # A股数据源
poetry add fastapi uvicorn       # Web服务
poetry add sqlalchemy python-dotenv # 数据库和配置

# 安装开发工具
poetry add --group dev pytest pytest-cov
poetry add --group dev black flake8 mypy

# 安装所有依赖（包括当前项目）
poetry install

# 故障排除：
# 如果遇到 "No file/folder found for package" 错误：
# 1. 确保 pulse_trader 目录存在且包含 __init__.py
# 2. 检查 pyproject.toml 中是否有 packages = [{include = "pulse_trader"}]
# 3. 运行 poetry lock 重新生成锁文件
# 4. 或者跳过当前项目安装：poetry install --no-root
```

### 3.7 验证 Poetry 环境

```bash
# 检查安装的依赖
poetry show

# 测试包导入
poetry run python -c "import pandas, numpy; print('✅ 核心包导入成功')"

# 测试项目包导入
poetry run python -c "import pulse_trader; print('✅ 项目包导入成功')"
```

---

## 步骤 4: 创建完整项目结构

### 4.1 创建基础目录结构

```bash
# 在项目根目录 (/home/jackluo/PulseTrader) 下执行

# Rust 引擎目录
mkdir -p engine/src/{data,indicators,risk,execution,utils}
mkdir -p engine/tests

# 数据存储目录
mkdir -p data/{raw,processed,cache,logs}
mkdir -p data/market/{daily,tick}

# 配置和文档目录
mkdir -p config
mkdir -p docs
mkdir -p scripts

# 创建 .gitkeep 文件保持空目录
touch data/raw/.gitkeep
touch data/processed/.gitkeep
touch data/cache/.gitkeep
touch data/logs/.gitkeep
```

### 4.2 目录说明
```
PulseTrader/
├── engine/                 # Rust 高性能引擎
│   └── src/               # Rust 源码
├── pulse_trader/          # Python 主包
│   ├── strategies/        # 交易策略
│   ├── backtest/          # 回测模块
│   ├── analysis/          # 分析模块
│   └── utils/             # 工具函数
├── data/                  # 数据存储
│   ├── raw/              # 原始数据
│   ├── processed/        # 处理后数据
│   └── market/           # 市场数据
├── config/               # 配置文件
├── docs/                 # 文档
└── scripts/              # 脚本
```

### 4.3 初始化 Rust 引擎

```bash
# 进入 engine 目录并初始化
cd engine
cargo init --lib

# 验证初始化
ls -la  # 应该看到 Cargo.toml 和 src/ 目录

# 添加核心依赖
cargo add pyo3 --features "extension-module abi3-py311"  # Python 绑定
cargo add numpy                                              # NumPy 支持
cargo add serde --features "derive"                         # 序列化
cargo add tokio --features "rt-multi-thread"              # 异步运行时
cargo add anyhow                                            # 错误处理

# 配置 Cargo.toml 用于 Python 扩展
cat >> Cargo.toml << 'EOF'

[lib]
name = "pulse_trader_engine"
crate-type = ["cdylib", "rlib"]

[package.metadata.maturin]
features = ["pyo3/extension-module"]
module-name = "pulse_trader_engine._pulse_trader_engine"
python-source = "../"

# 发布优化配置
[profile.release]
opt-level = 3
lto = true
codegen-units = 1
panic = "abort"
EOF

# 测试编译
cargo check
cargo test

cd ..  # 返回项目根目录
```

### 4.4 验证 Python 包
```bash
# 确保在项目根目录
pwd  # 应该显示 /home/jackluo/PulseTrader

# 确保虚拟环境已激活
source .venv/bin/activate

# 验证 Python 包导入（应该在步骤 3.7 中已验证）
python -c "import pulse_trader; print('✅ Python 包结构验证成功')"
```

---

## 步骤 5: 基础配置

### 5.1 创建 .gitignore
```bash
cat > .gitignore << 'EOF'
# Rust
target/
Cargo.lock
**/*.rs.bk

# Python
__pycache__/
*.py[cod]
*.so
build/
dist/
*.egg-info/

# 虚拟环境
venv/
env/

# IDE
.vscode/
.idea/

# 系统文件
.DS_Store
Thumbs.db

# 数据文件
data/raw/*
data/processed/*
data/cache/*
data/logs/*.log

# 配置文件 (包含敏感信息)
.env
.env.local
.env.production

# 测试和覆盖率
.coverage
.pytest_cache/

# 临时文件
*.tmp
*.temp
EOF
```

### 5.2 创建环境变量模板
```bash
cat > config/.env.example << 'EOF'
# 数据源配置
TUSHARE_TOKEN=your_tushare_token_here
AKSHARE_CACHE_ENABLED=true
PYTDX_SERVER=119.147.212.81
PYTDX_PORT=7709

# 数据库配置
DATABASE_URL=sqlite:///data/storage/trading.db

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=data/logs/pulse_trader.log

# 交易配置
DEFAULT_CAPITAL=1000000
COMMISSION_RATE=0.001
MAX_POSITION_SIZE=0.2
EOF
```

### 5.3 创建验证脚本

```bash
# 创建脚本目录
mkdir -p scripts

# 创建简单验证脚本
cat > scripts/verify_env.py << 'EOF'
#!/usr/bin/env python3
"""
MVP环境验证脚本
"""
import sys
import subprocess
import importlib
import os
from pathlib import Path

def check_rust():
    """检查 Rust 环境"""
    try:
        result = subprocess.run(['cargo', '--version'], capture_output=True, text=True)
        if result.returncode == 0:
            print(f"✅ Rust: {result.stdout.strip()}")
            return True
        else:
            print("❌ Rust 未正确安装")
            return False
    except FileNotFoundError:
        print("❌ Rust 未安装")
        return False

def check_python():
    """检查 Python 环境"""
    version = sys.version_info
    if version >= (3, 11):
        print(f"✅ Python: {version.major}.{version.minor}.{version.micro}")
        return True
    else:
        print(f"⚠️  Python 版本: {version.major}.{version.minor}")
        return True

def check_venv():
    """检查虚拟环境"""
    venv_path = Path('.venv')
    if not venv_path.exists():
        print("❌ 虚拟环境: .venv 目录不存在")
        return False

    if hasattr(sys, 'real_prefix') or (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix):
        print("✅ 虚拟环境: 已激活")
        return True
    else:
        print("⚠️  虚拟环境: 未激活")
        return False

def check_packages():
    """检查核心包"""
    required_packages = ['pandas', 'numpy', 'maturin', 'tushare', 'fastapi']

    all_ok = True
    for package in required_packages:
        try:
            importlib.import_module(package)
            print(f"✅ {package}")
        except ImportError:
            print(f"❌ {package} 未安装")
            all_ok = False

    return all_ok

def check_project_structure():
    """检查项目结构"""
    required_dirs = ['engine/src', 'pulse_trader', 'data', 'config']

    all_ok = True
    for directory in required_dirs:
        if os.path.exists(directory):
            print(f"✅ {directory}/")
        else:
            print(f"❌ {directory}/ 不存在")
            all_ok = False

    return all_ok

def main():
    """主验证函数"""
    print("🔍 MVP环境验证...")
    print("=" * 40)

    checks = [
        ("Rust 环境", check_rust),
        ("Python 环境", check_python),
        ("虚拟环境", check_venv),
        ("核心包", check_packages),
        ("项目结构", check_project_structure),
    ]

    all_passed = True
    for name, check_func in checks:
        print(f"\n📋 检查 {name}:")
        if not check_func():
            all_passed = False

    print("\n" + "=" * 40)
    if all_passed:
        print("🎉 MVP环境验证通过！")
    else:
        print("⚠️  环境验证失败，请检查上述问题")

if __name__ == "__main__":
    main()
EOF

chmod +x scripts/verify_env.py
```

### 5.4 配置 Git 仓库
```bash
# 初始化 Git 仓库
git init

# 配置用户信息 (如果还没有)
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 添加文件到 Git
git add .

# 创建初始提交
git commit -m "feat: 初始化 MVP 量化开发环境

- Rust 引擎基础配置
- Python 包结构创建
- Poetry 依赖管理设置
- 基础项目结构搭建
- 环境验证脚本"
```

---

## 步骤 6: 基础验证

### 6.1 运行环境验证
```bash
# 确保在项目根目录
pwd  # 应该显示 /home/jackluo/PulseTrader

# 激活虚拟环境
source .venv/bin/activate

# 运行验证脚本
python scripts/verify_env.py
```

### 6.2 Rust 引擎测试
```bash
# 进入 Rust 项目目录
cd engine

# 检查编译
cargo check

# 运行测试
cargo test

# 返回根目录
cd ..
```

### 6.3 Python 包测试
```bash
# 测试核心包导入
poetry run python -c "
import pandas, numpy, maturin, tushare, fastapi
print('✅ 所有核心包导入成功')
"

# 测试 Maturin 构建
cd engine
poetry run maturin develop
cd ..
```

---

## ✅ MVP 完成检查清单

### 核心环境
- [ ] **Python 3.11+** 已安装并可正常使用
- [ ] **Rust 1.90+** 已安装并可正常使用
- [ ] **Poetry** 已安装并配置
- [ ] **虚拟环境** 已创建并激活
- [ ] **核心依赖包** 已安装

### 项目结构
- [ ] **基础目录结构** 已创建
- [ ] **Rust 引擎** 已初始化
- [ ] **Python 包** 结构已创建
- [ ] **数据存储** 目录已准备

### 配置文件
- [ ] **.gitignore** 文件已创建
- [ ] **环境变量模板** 已创建
- [ ] **Git 仓库** 已初始化并提交

### 验证测试
- [ ] **环境验证**: `python scripts/verify_env.py` 运行成功
- [ ] **Rust 测试**: `cd engine && cargo check && cargo test` 通过
- [ ] **Python 测试**: 核心包导入成功
- [ ] **Maturin 测试**: 构建测试通过

---

## 🚀 下一步

🎉 **恭喜！您已成功建立最小可行的量化开发环境！**

### 📋 立即行动项

1. **提交环境配置**:
   ```bash
   git add .
   git commit -m "feat: 完成 MVP 量化开发环境搭建

   - Rust 引擎基础配置
   - Python 包结构创建
   - Poetry 依赖管理设置
   - 基础项目结构搭建
   - 环境验证脚本"
   ```

2. **开始下一阶段**:
   ```bash
   # 创建新分支
   git checkout -b feature/second-phase

   # 开始第二阶段开发
   ```

3. **阅读下一阶段文档**: [12-第二阶段-基础框架.md](./12-第二阶段-基础框架.md)

**💡 设计理念**: 精简启动，逐步迭代！

这个MVP环境包含了量化开发的核心要素，您可以：
- ✅ 开始编写 Rust 高性能数据引擎
- ✅ 开发 Python 策略模块
- ✅ 进行数据获取和处理
- ✅ 构建回测系统

**后续扩展**: 当需要时，可以逐步添加：
- 🚀 高性能计算框架 (Ray/Dask/Polars)
- 📊 专业数据库 (ClickHouse/Redis/PostgreSQL)
- 🐳 容器化部署
- 📈 专业监控系统

现在开始构建您的量化交易系统吧！🚀📈💰