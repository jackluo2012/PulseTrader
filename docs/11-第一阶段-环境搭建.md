# 第一阶段：开发环境搭建

> **目标**: 建立完整的 Rust+Python 混合开发环境
> **预计时间**: 1-2天
> **提交标记**: `first-commit`

## 📋 步骤概览

1. [✅] 系统要求检查
2. [ ] Rust 环境安装
3. [ ] Python 环境配置
4. [ ] 项目结构创建
5. [ ] 开发工具配置
6. [ ] 环境验证测试

---

## 步骤 1: 系统要求检查

### 1.1 操作系统支持
- ✅ **Linux** (Ubuntu 20.04+, CentOS 8+)
- ✅ **macOS** (10.15+)
- ✅ **Windows 10/11** (WSL2 强烈推荐)

### 1.2 硬件要求
- **内存**: 8GB+ (推荐 16GB)
- **存储**: 10GB+ 可用空间
- **网络**: 稳定的互联网连接

### 1.3 必需软件
- **Git**: 用于版本控制
- **Python**: 3.8+ (推荐 3.11)
- **Rust**: 1.70+ (最新稳定版)

**检查命令**:
```bash
# 检查系统信息
uname -a
python3 --version
git --version
```

---

## 步骤 2: Rust 环境安装

### 2.1 安装 Rust

**Linux/macOS**:
```bash
# 官方推荐安装方式
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 按提示输入 1 选择默认安装
# 安装完成后重新加载环境变量
source ~/.cargo/env
```

**Windows**:
1. 下载 [rustup-init.exe](https://rustup.rs/)
2. 双击运行，按提示安装
3. 重启命令行或 PowerShell

### 2.2 验证 Rust 安装

```bash
# 检查版本
rustc --version
cargo --version

# 应该显示类似信息：
# rustc 1.75.0 (82e1608df 2023-12-21)
# cargo 1.75.0 (1d8b23c2c 2023-12-21)
```

### 2.3 安装 Rust 开发工具

```bash
# 安装常用组件
rustup component add rustfmt clippy

# 安装常用工具
cargo install cargo-watch  # 自动重新编译
cargo install cargo-expand  # 宏展开工具
```

### 2.4 配置 Cargo 优化

创建 `~/.cargo/config.toml` 文件：

```toml
# ~/.cargo/config.toml

[build]
# 启用并行编译
jobs = 4

[target.x86_64-unknown-linux-gnu]
# Linux 优化配置
rustflags = ["-C", "target-cpu=native"]

[target.x86_64-apple-darwin]
# macOS 优化配置
rustflags = ["-C", "target-cpu=native"]

[target.x86_64-pc-windows-msvc]
# Windows 优化配置
rustflags = ["-C", "target-cpu=native"]

[registry]
# 使用国内镜像加速下载
# (可选，根据网络情况选择)
# index = "https://mirrors.ustc.edu.cn/crates.io-index/"
```

---

## 步骤 3: Python 环境配置

### 3.1 安装 Python (如果需要)

**Ubuntu/Debian**:
```bash
sudo apt update
sudo apt install python3 python3-pip python3-venv
```

**macOS** (推荐使用 Homebrew):
```bash
brew install python@3.11
```

**Windows**:
1. 从 [python.org](https://www.python.org/downloads/) 下载安装包
2. 安装时勾选 "Add Python to PATH"

### 3.2 安装 Poetry

Poetry 是现代 Python 依赖管理和打包工具。

**Linux/macOS**:
```bash
# 官方推荐安装方式
curl -sSL https://install.python-poetry.org | python3 -

# 重新加载环境变量
source ~/.bashrc  # 或 ~/.zshrc
```

**Windows** (PowerShell):
```powershell
# 使用 PowerShell 安装
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python3 -
```

**验证 Poetry 安装**:
```bash
poetry --version
# 应该显示类似: Poetry (version 1.7.1)
```

### 3.3 配置 Poetry

```bash
# 创建配置目录
mkdir -p ~/.config/pypoetry

# 配置虚拟环境在项目内创建
poetry config virtualenvs.in-project true

# 配置使用国内镜像源 (可选，加快下载速度)
poetry source add --priority=primary tsinghua https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 3.4 创建项目目录

```bash
# 进入您的工作目录
cd ~/Projects  # 或您喜欢的任何目录

# 创建项目根目录
mkdir PulseTrader
cd PulseTrader

# 验证当前位置
pwd  # 应该显示 ~/Projects/PulseTrader
```

---

## 步骤 4: 项目结构创建

### 4.1 创建基础目录结构

```bash
# 在项目根目录 (~/Projects/PulseTrader) 下执行

# Rust 引擎目录
mkdir -p engine/src/{data,indicators,risk,execution,ffi,utils}
mkdir -p engine/tests/{unit,integration}

# Python 接口目录
mkdir -p python/pulse_trader/{engine,strategies,backtest,analysis,utils}
mkdir -p python/tests/{unit,integration}

# 数据存储目录
mkdir -p data/{raw,processed,cache,storage}
mkdir -p data/logs

# 配置和文档目录
mkdir -p config
mkdir -p docs
mkdir -p examples
mkdir -p scripts

# 创建 .gitkeep 文件保持空目录
touch data/raw/.gitkeep
touch data/processed/.gitkeep
touch data/cache/.gitkeep
touch data/logs/.gitkeep
```

### 4.2 初始化 Rust 项目

```bash
# 进入 engine 目录并初始化
cd engine
cargo init --lib

# 验证初始化
ls -la  # 应该看到 Cargo.toml 和 src/ 目录
cat src/lib.rs  # 应该有基础的 Rust 代码

# 逐步添加依赖到 Cargo.toml

# 第一步：添加基础依赖
cargo add pyo3 --features "extension-module abi3-py38"
cargo add numpy

# 第二步：添加数据处理依赖
cargo add polars --features "lazy temporal strings"
cargo add serde --features "derive"
cargo add serde_json

# 第三步：添加异步运行时
cargo add tokio --features "full"
cargo add tokio-util

# 第四步：添加数学和网络依赖
cargo add num-complex
cargo add ordered-float
cargo add reqwest --features "json cookies"

# 第五步：添加错误处理和日志
cargo add anyhow
cargo add thiserror
cargo add tracing
cargo add tracing-subscriber --features "env-filter"

# 第六步：添加时间和配置依赖
cargo add chrono --features "serde"
cargo add config
cargo add toml

# 第七步：添加测试基准工具
cargo add --dev tokio-test
cargo add --dev tempfile
cargo add --dev criterion --features "html_reports"

# 手动编辑 Cargo.toml 添加发布配置和库类型
cat >> Cargo.toml << 'EOF'

# 配置库类型
[lib]
name = "pulse_trader_engine"
crate-type = ["cdylib", "rlib"]

# 基准测试配置
[[bench]]
name = "indicators"
harness = false

# 发布优化配置
[profile.release]
opt-level = 3
lto = true
codegen-units = 1
panic = "abort"

# 开发配置
[profile.dev]
opt-level = 1
debug = true
EOF

# 验证 Cargo.toml 配置
cat Cargo.toml

# 测试编译
cargo check
cargo build

# 运行测试确保一切正常
cargo test

cd ..  # 返回项目根目录
```

### 4.3 配置 Python 项目

```bash
# 使用 Poetry 创建 Python 项目
cd python

# 初始化 Poetry 项目
poetry init --no-interaction --name="pulse-trader" --description="A股量化交易系统" --author="Your Name <your.email@example.com>"

# 添加核心依赖 (批量添加)
poetry add pandas numpy matplotlib plotly scikit-learn requests fastapi uvicorn sqlalchemy python-dotenv pyyaml tushare akshare pytdx maturin

# 添加开发依赖
poetry add --group dev pytest pytest-cov black flake8 mypy pre-commit

# 查看生成的 pyproject.toml
cat pyproject.toml

# 安装依赖
poetry install

# 验证安装
poetry run python -c "import pandas, numpy, tushare, akshare; print('Python 包安装成功')"

cd ..  # 返回项目根目录
```

### 4.4 创建 pyproject.toml 的优化配置

Poetry 会自动生成 `python/pyproject.toml` 文件。为了更好的兼容性和性能，我们可以对其进行一些优化：

```bash
# 编辑 python/pyproject.toml 文件
cat >> python/pyproject.toml << 'EOF'

# 构建配置
[build-system]
requires = ["maturin>=1.4,<2.0"]
build-backend = "maturin"

[tool.maturin]
features = ["pyo3/extension-module"]
module-name = "pulse_trader_engine._pulse_trader_engine"
python-source = "python"

# Black 代码格式化配置
[tool.black]
line-length = 88
target-version = ['py38']
include = '\.pyi?$'

# Pytest 配置
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = "test_*.py"
python_classes = "Test*"
python_functions = "test_*"
addopts = "-v --tb=short --strict-markers"
markers = [
    "slow: marks tests as slow",
    "integration: marks tests as integration tests",
    "unit: marks tests as unit tests",
]

# MyPy 类型检查配置
[tool.mypy]
python_version = "3.8"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
EOF
```

---

## 步骤 5: 开发工具配置

### 5.1 创建 .gitignore

```bash
cat > .gitignore << 'EOF'
# Rust
target/
Cargo.lock
**/*.rs.bk
.cargo/

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# 虚拟环境
.venv/
venv/
env/
ENV/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# 系统文件
.DS_Store
Thumbs.db

# 数据文件
data/raw/*
data/processed/*
data/cache/*
data/storage/*.db
data/logs/*.log

# 配置文件 (包含敏感信息)
config/.env
.env.local
.env.production

# 测试和覆盖率
.coverage
htmlcov/
.pytest_cache/
.tox/

# Jupyter
.ipynb_checkpoints/

# 临时文件
*.tmp
*.temp
temp/
EOF
```

### 5.2 创建项目配置文件

```bash
# 创建环境变量模板
cat > config/.env.example << 'EOF'
# 数据源配置
TUSHARE_TOKEN=your_tushare_token_here
AKSHARE_CACHE_ENABLED=true
PYTDX_SERVER=119.147.212.81
PYTDX_PORT=7709

# 数据库配置
DATABASE_URL=sqlite:///data/storage/trading.db
REDIS_URL=redis://localhost:6379/0

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=data/logs/pulse_trader.log

# 交易配置
DEFAULT_CAPITAL=1000000
COMMISSION_RATE=0.001
SLIPPAGE_RATE=0.001
MAX_POSITION_SIZE=0.2

# 风险管理
MAX_DRAWDOWN=0.15
RISK_FREE_RATE=0.03
EOF

# 创建主配置文件
cat > config/config.yaml << 'EOF'
# PulseTrader 主配置文件

app:
  name: "PulseTrader"
  version: "0.1.0"
  debug: true
  environment: "development"

data_sources:
  primary: "akshare"
  fallback: "tushare"
  real_time: "pytdx"

  tushare:
    token: "${TUSHARE_TOKEN}"
    pro_api: "https://api.tushare.pro"
    rate_limit: 200  # 每分钟请求次数

  akshare:
    cache_enabled: true
    cache_dir: "data/cache/akshare"
    timeout: 30

  pytdx:
    servers:
      - host: "119.147.212.81"
        port: 7709
        name: "上海期货"
      - host: "202.108.253.130"
        port: 7709
        name: "深圳期货"
    timeout: 5
    retry_count: 3

database:
  type: "sqlite"
  url: "sqlite:///data/storage/trading.db"
  pool_size: 10

logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: "data/logs/pulse_trader.log"
  max_size: "100MB"
  backup_count: 5
EOF
```

### 5.3 创建开发脚本

```bash
# 创建脚本目录 (如果还没有)
mkdir -p scripts

# 创建环境验证脚本
cat > scripts/verify_env.py << 'EOF'
#!/usr/bin/env python3
"""
开发环境验证脚本
"""
import sys
import subprocess
import importlib
import os

def check_rust():
    """检查 Rust 环境"""
    try:
        result = subprocess.run(['cargo', '--version'],
                              capture_output=True, text=True)
        if result.returncode == 0:
            print(f"✅ Rust: {result.stdout.strip()}")
            return True
        else:
            print("❌ Rust 未正确安装")
            return False
    except FileNotFoundError:
        print("❌ Rust 未安装")
        return False

def check_python():
    """检查 Python 环境"""
    version = sys.version_info
    if version >= (3, 8):
        print(f"✅ Python: {version.major}.{version.minor}.{version.micro}")
        return True
    else:
        print(f"❌ Python 版本过低: {version.major}.{version.minor}")
        print("   需要 Python 3.8 或更高版本")
        return False

def check_packages():
    """检查必需的 Python 包"""
    required_packages = [
        'maturin', 'pandas', 'numpy', 'matplotlib',
        'tushare', 'akshare', 'pytdx', 'pytest', 'poetry'
    ]

    missing_packages = []
    for package in required_packages:
        try:
            importlib.import_module(package)
            print(f"✅ {package}")
        except ImportError:
            print(f"❌ {package} 未安装")
            missing_packages.append(package)

    return len(missing_packages) == 0

def check_poetry():
    """检查 Poetry 配置"""
    try:
        import subprocess
        result = subprocess.run(['poetry', '--version'],
                              capture_output=True, text=True)
        if result.returncode == 0:
            print(f"✅ Poetry: {result.stdout.strip()}")

            # 检查项目是否使用 Poetry
            if os.path.exists('python/pyproject.toml'):
                result = subprocess.run(['poetry', 'check'],
                                      cwd='python',
                                      capture_output=True, text=True)
                if result.returncode == 0:
                    print("✅ Poetry 项目配置正确")
                    return True
                else:
                    print("❌ Poetry 项目配置有误")
                    return False
            else:
                print("❌ 未找到 pyproject.toml 文件")
                return False
        else:
            print("❌ Poetry 未正确安装")
            return False
    except FileNotFoundError:
        print("❌ Poetry 未安装")
        return False

def check_project_structure():
    """检查项目目录结构"""
    required_dirs = [
        'engine/src', 'python/pulse_trader',
        'data', 'config', 'scripts'
    ]

    for directory in required_dirs:
        if os.path.exists(directory):
            print(f"✅ {directory}/")
        else:
            print(f"❌ {directory}/ 不存在")
            return False

    return True

def main():
    """主验证函数"""
    print("🔍 验证开发环境...")
    print("=" * 50)

    checks = [
        ("Rust 环境", check_rust),
        ("Python 环境", check_python),
        ("Poetry 配置", check_poetry),
        ("Python 包", check_packages),
        ("项目结构", check_project_structure),
    ]

    all_passed = True
    for name, check_func in checks:
        print(f"\n📋 检查 {name}:")
        if not check_func():
            all_passed = False

    print("\n" + "=" * 50)
    if all_passed:
        print("🎉 环境验证通过！可以开始开发了 🚀")
    else:
        print("⚠️  环境验证失败，请检查上述问题")
        print("\n💡 解决建议:")
        print("1. 确保已安装 Rust 和 Python 3.8+")
        print("2. 安装 Poetry: curl -sSL https://install.python-poetry.org | python3 -")
        print("3. 安装 Python 依赖: cd python && poetry install && cd ..")
        print("4. 确保在项目根目录执行此脚本")

if __name__ == "__main__":
    main()
EOF

# 给脚本执行权限
chmod +x scripts/verify_env.py
```

### 5.4 配置 Git 仓库

```bash
# 初始化 Git 仓库
git init

# 配置用户信息 (如果还没有)
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 创建初始提交
git add .
git commit -m "feat: 初始化项目结构和开发环境

- 配置 Rust 引擎环境
- 设置 Python 虚拟环境和依赖
- 创建基础项目目录结构
- 添加开发工具和配置文件
- 创建环境验证脚本"
```

---

## 步骤 6: 环境验证测试

### 6.1 运行验证脚本

```bash
# 确保在项目根目录
pwd  # 应该显示 ~/Projects/PulseTrader

# 确保虚拟环境已激活
# Linux/macOS: source .venv/bin/activate
# Windows: .\.venv\Scripts\Activate.ps1

# 运行验证脚本
python scripts/verify_env.py
```

**预期输出**:
```
🔍 验证开发环境...
==================================================

📋 检查 Rust 环境:
✅ Rust: cargo 1.75.0 (1d8b23c2c 2023-12-21)

📋 检查 Python 环境:
✅ Python: 3.11.6

📋 检查 Python 包:
✅ maturin
✅ pandas
✅ numpy
✅ matplotlib
✅ tushare
✅ akshare
✅ pytdx
✅ pytest

📋 检查项目结构:
✅ engine/src/
✅ python/pulse_trader/
✅ data/
✅ config/
✅ scripts/

==================================================
🎉 环境验证通过！可以开始开发了 🚀
```

### 6.2 Rust 编译测试

```bash
# 测试 Rust 项目编译
cd engine
cargo check
cargo build
cargo test
cd ..

# 如果编译成功，说明 Rust 环境配置正确
```

### 6.3 Python 环境测试

```bash
# 使用 Poetry 测试 Python 包导入
cd python
poetry run python -c "
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import tushare as ts
import akshare as ak
import pytdx as td
print('✅ 所有 Python 包导入成功')
"

# 测试 pytest
poetry run pytest --version

# 运行测试 (如果有测试文件)
poetry run pytest tests/ -v

cd ..
```

---

## ✅ 完成检查清单

在继续下一阶段之前，请确认以下所有项目都已完成：

### 环境配置
- [ ] Rust 1.70+ 已安装并可正常使用
- [ ] Python 3.8+ 已安装
- [ ] Poetry 已安装并配置
- [ ] Poetry 项目已初始化
- [ ] 所有必需的 Python 包已通过 Poetry 安装

### 项目结构
- [ ] 基础目录结构已创建
- [ ] Rust 项目已初始化 (`engine/Cargo.toml` 存在)
- [ ] Poetry 项目已初始化 (`python/pyproject.toml` 存在)

### 配置文件
- [ ] `.gitignore` 文件已创建
- [ ] 环境变量模板已创建 (`config/.env.example`)
- [ ] 主配置文件已创建 (`config/config.yaml`)
- [ ] Poetry 配置文件已创建 (`python/pyproject.toml`)
- [ ] Maturin 构建配置已添加

### 验证测试
- [ ] `python scripts/verify_env.py` 运行成功
- [ ] `cd engine && cargo check` 编译无错误
- [ ] `cd engine && cargo test` 测试通过
- [ ] `cd python && poetry run python -c "import pandas, numpy, tushare, akshare; print('Python 包导入成功')"`

### Git 提交
- [ ] 所有文件已提交到 Git 仓库
- [ ] 提交信息符合规范

---

## 🚨 常见问题解决

### 问题 1: Rust 安装后命令找不到
**解决方案**:
```bash
# 重新加载环境变量
source ~/.cargo/env

# 或者重启终端
```

### 问题 2: Poetry 安装失败
**解决方案**:
```bash
# 确保路径在 PATH 中
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# 或者使用 pip 安装
pip install poetry

# 验证安装
poetry --version
```

### 问题 3: Python 依赖安装失败
**解决方案**:
```bash
# 进入 Python 目录
cd python

# 使用 Poetry 安装依赖
poetry install

# 如果网络问题，使用国内镜像
poetry source add --priority=primary tsinghua https://pypi.tuna.tsinghua.edu.cn/simple/
poetry install

# 返回项目根目录
cd ..
```

### 问题 4: Cargo 编译速度慢
**解决方案**:
```bash
# 使用国内镜像源
mkdir -p ~/.cargo
cat >> ~/.cargo/config.toml << 'EOF'

[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"
EOF
```

### 问题 5: Poetry 虚拟环境问题
**解决方案**:
```bash
# 重新创建虚拟环境
cd python
poetry env remove python
poetry install

# 或者强制重新安装
poetry cache clear pypi --all
poetry install

cd ..
```

### 问题 6: 权限问题 (Linux/macOS)
**解决方案**:
```bash
# 给脚本执行权限
chmod +x scripts/*.py scripts/*.sh

# 或使用 python 直接运行
python scripts/verify_env.py

# 确保 Poetry 可执行权限
chmod +x ~/.local/bin/poetry
```

---

## 📝 开发记录

**完成时间**: ___________
**实际耗时**: ___________

### 遇到的问题
1.
2.
3.

### 解决方案
1.
2.
3.

### 学到的经验
1.
2.
3.

---

## 🎯 下一步

环境搭建完成后，您可以：

1. **提交代码**: `git add . && git commit -m "feat: 完成第一阶段环境搭建"`

2. **开始第二阶段**:
   ```bash
   # 切换到新的功能分支
   git checkout -b feature/second-phase
   ```

3. **阅读下一阶段文档**: [12-第二阶段-基础框架.md](./12-第二阶段-基础框架.md)

**恭喜完成第一阶段！** 🎉 您已经建立了完整的开发环境，可以开始实际的代码开发了。