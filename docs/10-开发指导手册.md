# PulseTrader 开发指导手册

## 📋 开发计划概览

本文档将指导您一步一步完成Rust+Python混合架构的量化交易系统开发。

### 🎯 开发目标
- 构建高性能的A股量化交易系统
- 整合多数据源（Tushare + pytdx + akshare）
- 实现完整的策略开发到回测流程
- 记录每一步的开发过程和经验

## 📅 开发阶段规划

### 第一阶段：基础设施搭建 (第1-2周)
**目标**: 建立开发环境和基础架构

- ✅ **步骤1**: 环境搭建和项目初始化
- ⏳ **步骤2**: Rust核心框架搭建
- ⏳ **步骤3**: Python接口层框架
- ⏳ **步骤4**: 基础配置和日志系统

### 第二阶段：数据层开发 (第3-4周)
**目标**: 实现多数据源统一接入

- ⏳ **步骤5**: 数据源抽象层设计
- ⏳ **步骤6**: Tushare数据接口实现
- ⏳ **步骤7**: akshare数据接口实现
- ⏳ **步骤8**: pytdx实时行情接口
- ⏳ **步骤9**: 数据质量验证和缓存机制

### 第三阶段：核心功能开发 (第5-6周)
**目标**: 实现技术指标和策略框架

- ⏳ **步骤10**: Rust技术指标计算引擎
- ⏳ **步骤11**: Python策略开发框架
- ⏳ **步骤12**: 经典策略模板实现

### 第四阶段：回测和风险管理 (第7-8周)
**目标**: 完善回测系统和风险控制

- ⏳ **步骤13**: 回测引擎实现
- ⏳ **步骤14**: 风险管理系统
- ⏳ **步骤15**: 性能分析和可视化

---

## 🚀 步骤1: 环境搭建和项目初始化

### 1.1 系统要求
- **操作系统**: Linux/macOS/Windows
- **Python**: 3.8+
- **Rust**: 1.70+
- **内存**: 8GB+ (推荐16GB)
- **存储**: 10GB+ 可用空间

### 1.2 安装Rust环境

```bash
# 安装Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source ~/.cargo/env

# 验证安装
rustc --version
cargo --version

# 安装常用组件
rustup component add rustfmt clippy
```

### 1.3 安装Python环境

```bash
# 创建Python虚拟环境
python -m venv venv

# 激活虚拟环境
# Linux/macOS:
source venv/bin/activate
# Windows:
venv\Scripts\activate

# 升级pip
pip install --upgrade pip

# 安装基础依赖
pip install maturin pandas numpy matplotlib pytest black
```

### 1.4 创建项目结构

```bash
# 创建项目根目录结构
mkdir -p core/src/{data,indicators,risk,execution,ffi}
mkdir -p python/pulse_trader/{core,strategies,backtest,analysis,utils}
mkdir -p data/{raw,processed,storage}
mkdir -p tests/{rust,python}
mkdir -p config
mkdir -p examples
mkdir -p docs

# 创建基础文件
touch core/src/lib.rs
touch python/pulse_trader/__init__.py
touch README.md
touch .gitignore
touch requirements.txt
```

### 1.5 初始化Rust项目

```bash
cd core
cargo init --lib

# 编辑Cargo.toml
cat > Cargo.toml << 'EOF'
[package]
name = "pulse-trader-core"
version = "0.1.0"
edition = "2021"
authors = ["Your Name <your.email@example.com>"]
description = "高性能量化交易核心引擎"

[lib]
name = "pulse_trader_core"
crate-type = ["cdylib"]

[dependencies]
# FFI和Python绑定
pyo3 = { version = "0.18", features = ["extension-module"] }
numpy = "0.18"

# 数据处理
polars = { version = "0.25", features = ["lazy", "temporal"] }
ndarray = "0.15"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# 并发和异步
tokio = { version = "1.0", features = ["full"] }
rayon = "1.5"

# 数学和统计
num-complex = "0.4"
statrs = "0.16"

# 网络和HTTP
reqwest = { version = "0.11", features = ["json"] }

# 错误处理
anyhow = "1.0"
thiserror = "1.0"

# 日志
tracing = "0.1"
tracing-subscriber = "0.3"

# 时间处理
chrono = { version = "0.4", features = ["serde"] }

[dev-dependencies]
tokio-test = "0.4"

[profile.release]
opt-level = 3
lto = true
codegen-units = 1
panic = "abort"
EOF

cd ..
```

### 1.6 配置Python包结构

```bash
cd python

# 创建pyproject.toml
cat > pyproject.toml << 'EOF'
[build-system]
requires = ["maturin>=1.0,<2.0"]
build-backend = "maturin"

[project]
name = "pulse-trader"
description = "A股量化交易系统"
authors = [
    {name = "Your Name", email = "your.email@example.com"},
]
license = {text = "MIT"}
requires-python = ">=3.8"
classifiers = [
    "Development Status :: 3 - Alpha",
    "Intended Audience :: Financial and Insurance Industry",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
]
dependencies = [
    "pandas>=1.3.0",
    "numpy>=1.21.0",
    "matplotlib>=3.4.0",
    "plotly>=5.0.0",
    "seaborn>=0.11.0",
    "scikit-learn>=1.0.0",
    "requests>=2.25.0",
    "python-dotenv>=0.19.0",
    "pyyaml>=6.0",
    "tushare>=1.2.0",
    "akshare>=1.8.0",
    "pytdx>=1.72.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=6.2.0",
    "pytest-cov>=3.0.0",
    "black>=21.0.0",
    "flake8>=4.0.0",
    "mypy>=0.910",
    "jupyter>=1.0.0",
]

[project.urls]
Homepage = "https://github.com/your-username/PulseTrader"
Documentation = "https://pulsetrader.readthedocs.io/"
Repository = "https://github.com/your-username/PulseTrader.git"
Issues = "https://github.com/your-username/PulseTrader/issues"

[tool.maturin]
python-source = "python"
module-name = "pulse_trader.core.pulse_trader_core"
features = ["pyo3/extension-module"]
EOF

# 创建requirements.txt
cat > requirements.txt << 'EOF'
# 核心依赖
pandas>=1.3.0
numpy>=1.21.0
matplotlib>=3.4.0
plotly>=5.0.0
seaborn>=0.11.0

# 数据源
tushare>=1.2.0
akshare>=1.8.0
pytdx>=1.72.0
requests>=2.25.0

# 机器学习
scikit-learn>=1.0.0

# 工具库
python-dotenv>=0.19.0
pyyaml>=6.0
tqdm>=4.62.0

# 开发工具
pytest>=6.2.0
pytest-cov>=3.0.0
black>=21.0.0
flake8>=4.0.0
mypy>=0.910
jupyter>=1.0.0
notebook>=6.4.0

# 构建工具
maturin>=1.0.0
setuptools>=60.0.0
wheel>=0.37.0
EOF

cd ..
```

### 1.7 创建配置文件

```bash
# 创建环境配置文件
cat > config/.env.example << 'EOF'
# 数据源配置
TUSHARE_TOKEN=your_tushare_token_here
AKSHARE_CACHE_ENABLED=true
PYTDX_SERVER=119.147.212.81
PYTDX_PORT=7709

# 数据库配置
DATABASE_URL=sqlite:///data/storage/trading.db
REDIS_URL=redis://localhost:6379/0

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/pulse_trader.log

# 交易配置
DEFAULT_CAPITAL=1000000
COMMISSION_RATE=0.001
SLIPPAGE_RATE=0.001
MAX_POSITION_SIZE=0.2

# 风险管理
MAX_DRAWDOWN=0.15
RISK_FREE_RATE=0.03
EOF

# 创建主配置文件
cat > config/config.yaml << 'EOF'
# PulseTrader 主配置文件

app:
  name: "PulseTrader"
  version: "0.1.0"
  debug: true
  environment: "development"

data_sources:
  primary: "akshare"
  fallback: "tushare"
  real_time: "pytdx"

  tushare:
    token: "${TUSHARE_TOKEN}"
    pro_api: "https://api.tushare.pro"
    rate_limit: 200  # 每分钟请求次数

  akshare:
    cache_enabled: true
    cache_dir: "data/cache/akshare"
    timeout: 30

  pytdx:
    servers:
      - host: "119.147.212.81"
        port: 7709
        name: "上海期货"
      - host: "202.108.253.130"
        port: 7709
        name: "深圳期货"
    timeout: 5
    retry_count: 3

database:
  type: "sqlite"
  url: "sqlite:///data/storage/trading.db"
  pool_size: 10

cache:
  type: "redis"
  url: "redis://localhost:6379/0"
  ttl: 3600  # 缓存时间（秒）

logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: "logs/pulse_trader.log"
  max_size: "100MB"
  backup_count: 5

trading:
  default_capital: 1000000
  commission: 0.001
  slippage: 0.001
  position_limit: 0.2

risk_management:
  max_drawdown: 0.15
  max_position_risk: 0.02
  var_confidence: 0.95
  risk_free_rate: 0.03

backtest:
  start_date: "2020-01-01"
  end_date: "2023-12-31"
  benchmark: "000300.SH"  # 沪深300
  rebalance_frequency: "daily"
EOF
```

### 1.8 创建开发工具配置

```bash
# 创建.gitignore
cat > .gitignore << 'EOF'
# Rust
target/
Cargo.lock
**/*.rs.bk

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# 虚拟环境
venv/
env/
ENV/
.venv/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# 系统文件
.DS_Store
Thumbs.db

# 数据文件
data/raw/*
data/processed/*
data/cache/*
data/storage/*.db
!data/raw/.gitkeep
!data/processed/.gitkeep
!data/cache/.gitkeep

# 日志文件
logs/
*.log

# 配置文件（包含敏感信息）
config/.env
.env.local

# Jupyter
.ipynb_checkpoints/

# 测试
.coverage
htmlcov/
.pytest_cache/
.pytest_cache/

# 模型文件
*.pkl
*.model
*.h5

# 临时文件
*.tmp
*.temp
temp/
EOF

# 创建pytest配置
cat > pytest.ini << 'EOF'
[tool:pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts =
    -v
    --tb=short
    --strict-markers
    --disable-warnings
    --cov=python/pulse_trader
    --cov-report=html
    --cov-report=term-missing
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    integration: marks tests as integration tests
    unit: marks tests as unit tests
EOF

# 创建pre-commit配置
cat > .pre-commit-config.yaml << 'EOF'
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
      - id: check-merge-conflict
      - id: debug-statements

  - repo: https://github.com/psf/black
    rev: 22.10.0
    hooks:
      - id: black
        language_version: python3.8

  - repo: https://github.com/pycqa/isort
    rev: 5.11.4
    hooks:
      - id: isort
        args: ["--profile", "black"]

  - repo: local
    hooks:
      - id: flake8
        name: flake8
        entry: flake8
        language: system
        types: [python]
        args: [--max-line-length=88, --extend-ignore=E203]

      - id: rust-fmt
        name: rust fmt
        entry: cargo fmt
        language: system
        files: \.rs$
        pass_filenames: false

      - id: rust-clippy
        name: rust clippy
        entry: cargo clippy
        language: system
        files: \.rs$
        args: [--all-targets, --all-features, --, -D, warnings]
        pass_filenames: false
EOF
```

### 1.9 创建基础Python模块

```bash
# 创建Python包初始化文件
cat > python/pulse_trader/__init__.py << 'EOF'
"""
PulseTrader - A股量化交易系统

高性能Rust+Python混合架构的量化交易平台
"""

__version__ = "0.1.0"
__author__ = "Your Name"
__email__ = "your.email@example.com"

from .core import DataEngine, TechnicalIndicators, RiskManager
from .strategies import Strategy, MACrossStrategy, RSIStrategy
from .backtest import BacktestEngine

__all__ = [
    "DataEngine",
    "TechnicalIndicators",
    "RiskManager",
    "Strategy",
    "MACrossStrategy",
    "RSIStrategy",
    "BacktestEngine",
]
EOF

# 创建核心模块初始化
touch python/pulse_trader/core/__init__.py
touch python/pulse_trader/strategies/__init__.py
touch python/pulse_trader/backtest/__init__.py
touch python/pulse_trader/analysis/__init__.py
touch python/pulse_trader/utils/__init__.py
```

### 1.10 创建开发和构建脚本

```bash
# 创建开发脚本
cat > scripts/setup.sh << 'EOF'
#!/bin/bash

echo "🚀 PulseTrader 开发环境初始化"

# 检查Rust
if ! command -v cargo &> /dev/null; then
    echo "❌ 请先安装Rust: https://rustup.rs/"
    exit 1
fi

# 检查Python
if ! command -v python &> /dev/null; then
    echo "❌ 请先安装Python 3.8+"
    exit 1
fi

# 安装pre-commit hooks
echo "📦 安装pre-commit hooks..."
pre-commit install

# 安装Python依赖
echo "📦 安装Python依赖..."
pip install -r python/requirements.txt

# 编译Rust核心
echo "🔨 编译Rust核心模块..."
cd core
cargo build --release
cd ..

# 构建Python扩展
echo "🔨 构建Python扩展..."
maturin develop --release

# 创建必要的目录
echo "📁 创建必要的目录..."
mkdir -p data/{raw,processed,storage,cache}
mkdir -p logs

# 复制配置文件
echo "⚙️ 配置环境..."
cp config/.env.example config/.env
echo "请编辑 config/.env 文件，设置您的API密钥"

echo "✅ 开发环境初始化完成！"
echo ""
echo "下一步："
echo "1. 编辑 config/.env 文件设置API密钥"
echo "2. 运行 pytest 进行测试"
echo "3. 查看 examples/ 目录中的示例"
EOF

chmod +x scripts/setup.sh

# 创建构建脚本
cat > scripts/build.sh << 'EOF'
#!/bin/bash

echo "🔨 构建 PulseTrader"

# 清理之前的构建
echo "🧹 清理之前的构建..."
rm -rf python/target/
rm -rf python/build/

# 编译Rust核心
echo "🦀 编译Rust核心模块..."
cd core
cargo build --release
cargo test --release
cargo clippy --release -- -D warnings
cd ..

# 构建Python包
echo "🐍 构建Python包..."
maturin build --release

# 运行Python测试
echo "🧪 运行Python测试..."
cd python
python -m pytest tests/ -v
cd ..

echo "✅ 构建完成！"
echo "包文件位置: target/wheels/"
EOF

chmod +x scripts/build.sh

# 创建测试脚本
cat > scripts/test.sh << 'EOF'
#!/bin/bash

echo "🧪 运行测试套件"

# Rust测试
echo "🦀 Rust单元测试..."
cd core
cargo test --release
cd ..

# Python测试
echo "🐍 Python测试..."
cd python
python -m pytest tests/ -v --cov=pulse_trader --cov-report=html
cd ..

# 集成测试
echo "🔗 集成测试..."
cd tests
python integration_tests.py
cd ..

echo "✅ 所有测试完成！"
EOF

chmod +x scripts/test.sh
```

### 1.11 验证环境搭建

```bash
# 创建验证脚本
cat > scripts/verify_setup.py << 'EOF'
#!/usr/bin/env python3
"""
环境验证脚本
"""

import sys
import subprocess
import importlib

def check_rust():
    """检查Rust环境"""
    try:
        result = subprocess.run(['cargo', '--version'],
                              capture_output=True, text=True)
        print(f"✅ Rust: {result.stdout.strip()}")
        return True
    except FileNotFoundError:
        print("❌ Rust未安装")
        return False

def check_python():
    """检查Python环境"""
    version = sys.version_info
    if version >= (3, 8):
        print(f"✅ Python: {version.major}.{version.minor}.{version.micro}")
        return True
    else:
        print(f"❌ Python版本过低: {version.major}.{version.minor}")
        return False

def check_packages():
    """检查Python包"""
    required_packages = [
        'maturin', 'pandas', 'numpy', 'matplotlib',
        'tushare', 'akshare', 'pytdx'
    ]

    for package in required_packages:
        try:
            importlib.import_module(package)
            print(f"✅ {package}")
        except ImportError:
            print(f"❌ {package}未安装")
            return False

    return True

def check_rust_core():
    """检查Rust核心模块"""
    try:
        result = subprocess.run(['cargo', 'check'],
                              cwd='core', capture_output=True)
        if result.returncode == 0:
            print("✅ Rust核心模块编译通过")
            return True
        else:
            print("❌ Rust核心模块编译失败")
            return False
    except:
        print("❌ 无法检查Rust核心模块")
        return False

def main():
    """主验证函数"""
    print("🔍 验证开发环境...")
    print()

    checks = [
        ("Rust环境", check_rust),
        ("Python环境", check_python),
        ("Python包", check_packages),
        ("Rust核心", check_rust_core),
    ]

    all_passed = True
    for name, check_func in checks:
        if not check_func():
            all_passed = False

    print()
    if all_passed:
        print("🎉 环境验证通过！")
        print("可以开始开发了：)")
    else:
        print("⚠️  环境验证失败，请检查上述问题")

if __name__ == "__main__":
    main()
EOF

chmod +x scripts/verify_setup.py
```

### 1.12 运行环境初始化

```bash
# 给脚本执行权限
chmod +x scripts/*.sh

# 运行环境初始化
./scripts/setup.sh

# 验证环境
python scripts/verify_setup.py
```

## 📝 开发记录模板

### 步骤1完成记录

**完成时间**: 2024-XX-XX
**耗时**: X小时

#### 完成的内容
- ✅ Rust环境安装和配置
- ✅ Python虚拟环境设置
- ✅ 项目目录结构创建
- ✅ 基础配置文件编写
- ✅ 开发工具配置

#### 遇到的问题
1. **问题**: maturin安装失败
   - **解决**: 使用pip install --upgrade maturin
2. **问题**: Rust编译速度慢
   - **解决**: 配置了增量编译和优化选项

#### 学到的经验
- Rust和Python的混合架构需要仔细规划FFI接口
- 配置文件管理对项目维护很重要
- 自动化脚本能大幅提升开发效率

#### 下一步计划
- 开始实现Rust核心数据结构
- 设计数据源抽象接口
- 实现基础的技术指标计算

---

## 📚 后续步骤预览

### 步骤2: Rust核心框架搭建
- 实现基础数据结构
- 创建FFI接口框架
- 实现错误处理机制

### 步骤3: Python接口层框架
- 设计Python包结构
- 实现配置管理系统
- 创建日志系统

### 步骤4: 数据源抽象层
- 设计统一的数据源接口
- 实现数据质量验证
- 创建缓存机制

---

## 💡 开发建议

1. **代码提交规范**: 每完成一个步骤后及时提交代码
2. **文档同步**: 边开发边更新文档
3. **测试驱动**: 先写测试，再写实现
4. **小步快跑**: 将大任务拆分成小任务逐步完成

## 🔗 有用链接

- [Rust官方文档](https://doc.rust-lang.org/)
- [PyO3文档](https://pyo3.rs/)
- [Maturin文档](https://www.maturin.rs/)
- [Tushare文档](https://tushare.pro/document/)
- [akshare文档](https://akshare.akfamily.xyz/)
- [pytdx文档](https://github.com/shidenggui/pytdx)

---

**当前状态**: ✅ 步骤1完成，环境搭建完毕
**下一步**: 开始步骤2 - Rust核心框架搭建