# 2.4 é…ç½®ç®¡ç†ä¸ä¼˜åŒ–

## æ¦‚è¿°

PulseTrader å¼•å…¥äº†ç°ä»£åŒ–çš„é…ç½®ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒåŸºäº YAML çš„é…ç½®æ–‡ä»¶ï¼Œå®ç°äº†æ•°æ®é‡‡é›†å‚æ•°çš„é›†ä¸­ç®¡ç†å’ŒåŠ¨æ€é…ç½®ã€‚

## ğŸ¯ è§£å†³çš„é—®é¢˜

### åŸå§‹é—®é¢˜
- `timedelta` å¯¼å…¥é”™è¯¯å¯¼è‡´çš„ NameError
- å®æ—¶æ•°æ®é‡‡é›†å™¨ç½‘ç»œè¿æ¥ä¸ç¨³å®š
- ç¡¬ç¼–ç çš„é…ç½®å‚æ•°éš¾ä»¥ç»´æŠ¤
- Git locale è­¦å‘Šé—®é¢˜

### è§£å†³æ–¹æ¡ˆ
- âœ… ä¿®å¤æ‰€æœ‰å¯¼å…¥é”™è¯¯
- âœ… å¢å¼ºç½‘ç»œé²æ£’æ€§å’Œé‡è¯•æœºåˆ¶
- âœ… å¼•å…¥é…ç½®æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ
- âœ… è§£å†³ locale ç¯å¢ƒé—®é¢˜

## ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„

### é…ç½®æ–‡ä»¶ä½ç½®
```
PulseTrader/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ data_collection.yaml    # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ src/
â”‚   â””â”€â”€ config/
â”‚       â””â”€â”€ config_manager.py   # é…ç½®ç®¡ç†å™¨
â””â”€â”€ scripts/
    â”œâ”€â”€ setup_env.sh           # ç¯å¢ƒè®¾ç½®è„šæœ¬
    â””â”€â”€ test_config_manager.py  # é…ç½®æµ‹è¯•è„šæœ¬
```

### é…ç½®æ–‡ä»¶å†…å®¹ (config/data_collection.yaml)

```yaml
# Akshare æ•°æ®æºé…ç½®
akshare:
  timeout: 30          # è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  max_retries: 3       # æœ€å¤§é‡è¯•æ¬¡æ•°
  delay: 1.0          # è¯·æ±‚é—´éš”ï¼ˆç§’ï¼‰

  # æ•°æ®ç±»å‹é…ç½®
  data_types:
    stock_info:
      enabled: true
      update_interval: "1d"
      retry_on_error: true

    realtime:
      enabled: true
      update_interval: "10s"
      trading_hours_only: true

    historical:
      enabled: true
      update_interval: "1d"
      batch_size: 50
      max_days_per_request: 365

    financial:
      enabled: true
      update_interval: "1d"
      quarterly_update: true

# å­˜å‚¨é…ç½®
storage:
  clickhouse:
    batch_size: 1000
    connection_timeout: 30

  cache:
    redis:
      ttl: 3600
      max_memory: "100MB"

# é”™è¯¯å¤„ç†é…ç½®
error_handling:
  max_consecutive_errors: 5
  error_backoff_factor: 2
  notification_enabled: false
```

## ğŸ”§ é…ç½®ç®¡ç†å™¨åŠŸèƒ½

### æ ¸å¿ƒç‰¹æ€§
1. **YAML é…ç½®æ–‡ä»¶æ”¯æŒ**
2. **åµŒå¥—é…ç½®è®¿é—®**
3. **é»˜è®¤é…ç½®å›é€€**
4. **é…ç½®éªŒè¯**
5. **åŠ¨æ€é‡è½½**
6. **ä¾¿æ·è®¿é—®å‡½æ•°**

### ä½¿ç”¨ç¤ºä¾‹

```python
from src.config.config_manager import get_config_manager, get_config

# è·å–é…ç½®ç®¡ç†å™¨å®ä¾‹
config = get_config_manager()

# åŸºæœ¬é…ç½®è·å–
timeout = config.get_timeout()           # 30
max_retries = config.get_max_retries()  # 3
delay = config.get_delay()              # 1.0

# åµŒå¥—é…ç½®è·å–
batch_size = config.get('akshare.data_types.historical.batch_size')  # 50

# ä¾¿æ·å‡½æ•°
cache_ttl = get_config('storage.cache.redis.ttl', 3600)  # 3600

# æ•°æ®ç±»å‹æ£€æŸ¥
is_realtime_enabled = config.is_data_type_enabled('realtime')  # True
```

## ğŸš€ æ•°æ®é‡‡é›†å™¨é›†æˆ

### åŸºç±»æ”¹è¿›

BaseCollector ç°åœ¨æ”¯æŒä»é…ç½®æ–‡ä»¶è¯»å–å‚æ•°ï¼š

```python
class BaseCollector(ABC):
    def __init__(self, max_retries: int = None, delay: float = None, use_config: bool = True):
        # ä»é…ç½®æ–‡ä»¶è¯»å–å‚æ•°
        if use_config and get_config_manager:
            config = get_config_manager()
            self.max_retries = max_retries if max_retries is not None else config.get_max_retries()
            self.delay = delay if delay is not None else config.get_delay()
        else:
            # ä½¿ç”¨é»˜è®¤å€¼æˆ–ä¼ å…¥å‚æ•°
            self.max_retries = max_retries if max_retries is not None else 3
            self.delay = delay if delay is not None else 1.0
```

### ä½¿ç”¨æ–¹å¼

```python
# 1. ä½¿ç”¨é…ç½®æ–‡ä»¶çš„é»˜è®¤å‚æ•°
collector = HistoricalCollector()

# 2. è‡ªå®šä¹‰å‚æ•°ï¼ˆè¦†ç›–é…ç½®æ–‡ä»¶ï¼‰
collector = HistoricalCollector(max_retries=5, delay=2.0)

# 3. å®Œå…¨ä¸ä½¿ç”¨é…ç½®æ–‡ä»¶
collector = HistoricalCollector(use_config=False, max_retries=10)
```

## ğŸ›¡ï¸ ç½‘ç»œé²æ£’æ€§å¢å¼º

### RealtimeCollector æ”¹è¿›

1. **å¤šå±‚å¤‡ç”¨æ–¹æ¡ˆ**
   - ä¸»è¦æ–¹æ¡ˆï¼š`stock_zh_a_spot_em` è·å–å…¨å¸‚åœºæ•°æ®
   - å¤‡ç”¨æ–¹æ¡ˆï¼š`stock_zh_a_hist` è·å–æœ€æ–°äº¤æ˜“æ—¥æ•°æ®
   - æœ€ç»ˆä¿éšœï¼šè¿”å›ç»“æ„åŒ–ç©ºDataFrame

2. **ä¼˜é›…é”™è¯¯å¤„ç†**
   ```python
   try:
       market_data = self._call_api(ak.stock_zh_a_spot_em)
       # å¤„ç†æ•°æ®...
   except Exception as e:
       logger.info("å°è¯•å¤‡ç”¨æ–¹æ¡ˆè·å–æŒ‡æ•°æ•°æ®")
       # å¤‡ç”¨æ–¹æ¡ˆ...
       logger.warning("æœªèƒ½è·å–å¸‚åœºæ¦‚è§ˆæ•°æ®ï¼Œè¿”å›ç©ºDataFrame")
       return pd.DataFrame()  # ä¸å´©æºƒ
   ```

3. **é‡è¯•æœºåˆ¶**
   - è‡ªåŠ¨é‡è¯•ï¼ˆå¯é…ç½®æ¬¡æ•°ï¼‰
   - é€’å¢å»¶è¿Ÿç­–ç•¥
   - è¯¦ç»†é”™è¯¯æ—¥å¿—

## ğŸ” ç¯å¢ƒè®¾ç½®

### Git Locale ä¿®å¤

åˆ›å»º `scripts/setup_env.sh` è„šæœ¬ï¼š

```bash
#!/bin/bash
# è®¾ç½® locale ç¯å¢ƒå˜é‡
export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

# å…¶ä»–ç¯å¢ƒè®¾ç½®...
```

### ä½¿ç”¨æ–¹æ³•

```bash
# è¿è¡Œç¯å¢ƒè®¾ç½®è„šæœ¬
source scripts/setup_env.sh

# æˆ–æ‰‹åŠ¨è®¾ç½®
export LANGUAGE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
```

## ğŸ“Š æµ‹è¯•ä¸éªŒè¯

### æµ‹è¯•è„šæœ¬

1. **é…ç½®ç®¡ç†å™¨æµ‹è¯•**
   ```bash
   python scripts/test_config_manager.py
   ```

2. **å®æ—¶é‡‡é›†å™¨æµ‹è¯•**
   ```bash
   python scripts/test_realtime_collector.py
   ```

3. **å®Œæ•´æ•°æ®é‡‡é›†æµ‹è¯•**
   ```bash
   python scripts/test_data_collection.py
   ```

### æµ‹è¯•è¦†ç›–

- âœ… é…ç½®æ–‡ä»¶åŠ è½½
- âœ… åµŒå¥—é…ç½®è®¿é—®
- âœ… é»˜è®¤å€¼å›é€€
- âœ… é…ç½®éªŒè¯
- âœ… é”™è¯¯å¤„ç†
- âœ… ç½‘ç»œé²æ£’æ€§
- âœ… é‡è¯•æœºåˆ¶
- âœ… æ•°æ®é‡‡é›†å™¨é›†æˆ

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é…ç½®ç®¡ç†
- ä½¿ç”¨ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—®
- ä¸ºæ‰€æœ‰é…ç½®é¡¹æä¾›åˆç†çš„é»˜è®¤å€¼
- å®šæœŸéªŒè¯é…ç½®çš„æœ‰æ•ˆæ€§

### 2. é”™è¯¯å¤„ç†
- å®ç°å¤šå±‚å¤‡ç”¨æ–¹æ¡ˆ
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- ä¼˜é›…é™çº§ï¼Œé¿å…ç¨‹åºå´©æºƒ

### 3. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®è¯·æ±‚é—´éš”
- ä½¿ç”¨æ‰¹é‡å¤„ç†å‡å°‘APIè°ƒç”¨
- å¯ç”¨ç¼“å­˜æœºåˆ¶

### 4. å¼€å‘ç¯å¢ƒ
- ç»Ÿä¸€è®¾ç½® locale ç¯å¢ƒå˜é‡
- ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒéš”ç¦»ä¾èµ–
- å®šæœŸæ›´æ–°ä¾èµ–åŒ…ç‰ˆæœ¬

## ğŸ”„ åç»­æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
1. **é…ç½®çƒ­é‡è½½**ï¼šæ— éœ€é‡å¯å³å¯æ›´æ–°é…ç½®
2. **ç¯å¢ƒç‰¹å®šé…ç½®**ï¼šå¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒåˆ†ç¦»
3. **é…ç½®åŠ å¯†**ï¼šæ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
4. **è¿œç¨‹é…ç½®**ï¼šæ”¯æŒä»è¿œç¨‹æœåŠ¡å™¨è·å–é…ç½®
5. **é…ç½®ç‰ˆæœ¬ç®¡ç†**ï¼šé…ç½®å˜æ›´å†å²è¿½è¸ª

### é›†æˆå»ºè®®
1. **ç›‘æ§ç³»ç»Ÿ**ï¼šé›†æˆé…ç½®ç›‘æ§å’Œå‘Šè­¦
2. **æ—¥å¿—èšåˆ**ï¼šç»Ÿä¸€æ—¥å¿—æ”¶é›†å’Œåˆ†æ
3. **æ€§èƒ½ç›‘æ§**ï¼šAPIè°ƒç”¨æ€§èƒ½æŒ‡æ ‡æ”¶é›†
4. **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šCI/CD é›†æˆæµ‹è¯•æµç¨‹

## ğŸ“ æ€»ç»“

é€šè¿‡å¼•å…¥é…ç½®ç®¡ç†ç³»ç»Ÿå’Œç½‘ç»œé²æ£’æ€§ä¼˜åŒ–ï¼ŒPulseTrader æ•°æ®é‡‡é›†æ¨¡å—ç°åœ¨å…·å¤‡äº†ï¼š

- ğŸ¯ **é›†ä¸­é…ç½®ç®¡ç†**ï¼šæ‰€æœ‰å‚æ•°ç»Ÿä¸€é…ç½®
- ğŸ›¡ï¸ **é«˜å¯é æ€§**ï¼šå¤šé‡å¤‡ç”¨æ–¹æ¡ˆå’Œé”™è¯¯å¤„ç†
- âš¡ **é«˜æ€§èƒ½**ï¼šå¯é…ç½®çš„é‡è¯•å’Œå»¶è¿Ÿç­–ç•¥
- ğŸ”§ **æ˜“ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„é…ç½®ç»“æ„å’Œç®¡ç†æ¥å£
- ğŸŒ **ç¯å¢ƒå…¼å®¹**ï¼šè§£å†³äº†è·¨å¹³å°å…¼å®¹æ€§é—®é¢˜

è¿™äº›æ”¹è¿›ä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å’Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚
