# ç¬¬ä¸€ç« ï¼šç¯å¢ƒæ­å»ºä¸é¡¹ç›®åˆå§‹åŒ–

## 1.1 Python 3.12 å¼€å‘ç¯å¢ƒé…ç½®

### å­¦ä¹ ç›®æ ‡
- å®‰è£…å¹¶é…ç½® Python 3.12 å¼€å‘ç¯å¢ƒ
- è®¾ç½®ä¸“ä¸šçš„å¼€å‘å·¥å…·é“¾
- åˆ›å»ºæ ‡å‡†åŒ–çš„é¡¹ç›®ç»“æ„

### é¢„è®¡å®Œæˆæ—¶é—´
15-20åˆ†é’Ÿ

---

### æ­¥éª¤1ï¼šæ£€æŸ¥å½“å‰Pythonç‰ˆæœ¬

é¦–å…ˆæ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦å·²ç»å®‰è£…äº†Pythonï¼š

```bash
# æ£€æŸ¥Pythonç‰ˆæœ¬
python3 --version
python --version

# å¦‚æœç‰ˆæœ¬ä¸æ˜¯3.12.xï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…æœ€æ–°ç‰ˆæœ¬
```

**é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š**
```
Python 3.11.5  # å¦‚æœæ˜¾ç¤ºè¿™ä¸ªç‰ˆæœ¬ï¼Œéœ€è¦å‡çº§åˆ°3.12
```

### æ­¥éª¤2ï¼šå®‰è£…Python 3.12

#### åœ¨Ubuntu/WSL2ä¸Šå®‰è£…ï¼š

```bash
# æ›´æ–°åŒ…åˆ—è¡¨
sudo apt update

# æ·»åŠ deadsnakes PPAï¼ˆåŒ…å«æœ€æ–°çš„Pythonç‰ˆæœ¬ï¼‰
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update

# å®‰è£…Python 3.12åŠç›¸å…³å·¥å…·
sudo apt install python3.12 python3.12-venv python3.12-dev python3.12-pip

# éªŒè¯å®‰è£…
python3.12 --version
```

#### åœ¨macOSä¸Šå®‰è£…ï¼š

```bash
# ä½¿ç”¨Homebrewå®‰è£…
brew install python@3.12

# éªŒè¯å®‰è£…
python3.12 --version
```

#### åœ¨Windowsä¸Šå®‰è£…ï¼š

1. è®¿é—® [python.org](https://python.org)
2. ä¸‹è½½Python 3.12æœ€æ–°ç¨³å®šç‰ˆ
3. è¿è¡Œå®‰è£…ç¨‹åºï¼Œ**åŠ¡å¿…å‹¾é€‰"Add Python to PATH"**
4. éªŒè¯å®‰è£…ï¼šæ‰“å¼€å‘½ä»¤æç¤ºç¬¦è¾“å…¥ `python --version`

### æ­¥éª¤3ï¼šåˆ›å»ºé¡¹ç›®è™šæ‹Ÿç¯å¢ƒ

è™šæ‹Ÿç¯å¢ƒå¯ä»¥éš”ç¦»é¡¹ç›®ä¾èµ–ï¼Œé¿å…ä¸åŒé¡¹ç›®é—´çš„ç‰ˆæœ¬å†²çªã€‚

```bash
# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd /home/jackluo/data/PulseTrader

# åˆ›å»ºPython 3.12è™šæ‹Ÿç¯å¢ƒ
python3.12 -m venv .venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Linux/macOS:
source .venv/bin/activate
# Windows:
# .venv\Scripts\activate

# éªŒè¯è™šæ‹Ÿç¯å¢ƒ
which python  # åº”è¯¥æ˜¾ç¤ºé¡¹ç›®ç›®å½•ä¸‹çš„pythonè·¯å¾„
python --version  # åº”è¯¥æ˜¾ç¤ºPython 3.12.x
```

**æˆåŠŸæ¿€æ´»åï¼Œä½ ä¼šçœ‹åˆ°å‘½ä»¤è¡Œå‰é¢æœ‰ `(.venv)` æ ‡è¯†ã€‚**

### æ­¥éª¤4ï¼šå‡çº§pipå’Œå®‰è£…åŸºç¡€å·¥å…·

```bash
# å‡çº§pipåˆ°æœ€æ–°ç‰ˆæœ¬
pip install --upgrade pip

# å®‰è£…é¡¹ç›®ç®¡ç†å’Œæ‰“åŒ…å·¥å…·
pip install poetry setuptools wheel maturin

# éªŒè¯å®‰è£…
poetry --version
maturin --version
```

### æ­¥éª¤5ï¼šé…ç½®å¼€å‘å·¥å…·

#### 5.1 å®‰è£…VS Codeï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰

```bash
# Ubuntu/WSL2
sudo snap install code --classic

# æˆ–è€…ä»å®˜ç½‘ä¸‹è½½ï¼šhttps://code.visualstudio.com/
```

#### 5.2 å®‰è£…å¿…è¦çš„VS Codeæ‰©å±•

æ‰“å¼€VS Codeï¼ŒæŒ‰ `Ctrl+Shift+X` æ‰“å¼€æ‰©å±•é¢æ¿ï¼Œå®‰è£…ä»¥ä¸‹æ‰©å±•ï¼š

1. **Python** (Microsoftå®˜æ–¹) - Pythonè¯­è¨€æ”¯æŒ
2. **Pylance** - Pythonæ™ºèƒ½æç¤ºå’Œç±»å‹æ£€æŸ¥
3. **Python Docstring Generator** - è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£å­—ç¬¦ä¸²
4. **GitLens** - Gitå¢å¼ºåŠŸèƒ½
5. **Docker** - å®¹å™¨æ”¯æŒï¼ˆåç»­ç« èŠ‚éœ€è¦ï¼‰
6. **ClickHouse** - ClickHouseæ•°æ®åº“æ”¯æŒ

#### 5.3 é…ç½®VS Code Pythonè®¾ç½®

åœ¨VS Codeä¸­æŒ‰ `Ctrl+Shift+P`ï¼Œè¾“å…¥ `Open Settings (JSON)`ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```json
{
    "python.defaultInterpreterPath": "./.venv/bin/python",
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.formatting.provider": "black",
    "python.formatting.blackArgs": ["--line-length=88"],
    "python.testing.pytestEnabled": true,
    "files.exclude": {
        "**/__pycache__": true,
        "**/*.pyc": true
    }
}
```

### æ­¥éª¤6ï¼šåˆ›å»ºé¡¹ç›®é…ç½®æ–‡ä»¶

#### 6.1 åˆ›å»º `pyproject.toml`

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºé…ç½®æ–‡ä»¶
cat > pyproject.toml << 'EOF'
[tool.poetry]
name = "pulse-trader"
version = "0.1.0"
description = "Aè‚¡é‡åŒ–äº¤æ˜“ç³»ç»Ÿ"
authors = ["Your Name <your.email@example.com>"]
readme = "README.md"
python = "^3.12"

[tool.poetry.dependencies]
python = "^3.12"
pandas = "^2.3.3"
numpy = "^2.3.5"
akshare = "^1.17.87"
clickhouse-driver = "^0.2.10"

[tool.poetry.group.dev.dependencies]
pytest = "^8.0.0"
black = "^24.0.0"
pylint = "^3.0.0"
mypy = "^1.0.0"
maturin = "^1.10.2"

[tool.maturin]
python-source = "python"
module-name = "pulse_trader_rust._core"
features = ["pyo3/extension-module"]

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"

[tool.black]
line-length = 88
target-version = ['py312']

[tool.pylint.messages_control]
disable = ["C0114", "C0115", "C0116"]
EOF
```

#### 6.2 åˆ›å»º `.gitignore`

```bash
cat > .gitignore << 'EOF'
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# Virtual Environment
.venv/
venv/
env/

# IDE
.vscode/
.idea/
*.swp
*.swo

# Data
data/raw/*
data/processed/*
!data/raw/.gitkeep
!data/processed/.gitkeep

# Logs
logs/
*.log

# Environment Variables
.env
.env.local

# Database
*.db
*.sqlite

# OS
.DS_Store
Thumbs.db
EOF
```

### æ­¥éª¤7ï¼šéªŒè¯ç¯å¢ƒé…ç½®

```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
pip install pandas numpy akshare clickhouse-driver

# åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯ç¯å¢ƒ
cat > test_environment.py << 'EOF'
#!/usr/bin/env python3
"""
ç¯å¢ƒæµ‹è¯•è„šæœ¬
éªŒè¯æ‰€æœ‰ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
"""

def test_imports():
    """æµ‹è¯•æ‰€æœ‰æ ¸å¿ƒåº“çš„å¯¼å…¥"""
    try:
        import pandas as pd
        print(f"âœ“ pandas: {pd.__version__}")
    except ImportError as e:
        print(f"âœ— pandaså¯¼å…¥å¤±è´¥: {e}")

    try:
        import numpy as np
        print(f"âœ“ numpy: {np.__version__}")
    except ImportError as e:
        print(f"âœ— numpyå¯¼å…¥å¤±è´¥: {e}")

    try:
        import akshare as ak
        print(f"âœ“ akshare: {ak.__version__}")
    except ImportError as e:
        print(f"âœ— akshareå¯¼å…¥å¤±è´¥: {e}")

    try:
        import clickhouse_driver
        print(f"âœ“ clickhouse_driver: æˆåŠŸå¯¼å…¥")
    except ImportError as e:
        print(f"âœ— clickhouse_driverå¯¼å…¥å¤±è´¥: {e}")

def test_basic_functionality():
    """æµ‹è¯•åŸºç¡€åŠŸèƒ½"""
    try:
        import pandas as pd
        import numpy as np

        # æµ‹è¯•pandasåŸºç¡€æ“ä½œ
        df = pd.DataFrame({
            'date': pd.date_range('2024-01-01', periods=5),
            'price': [100.0, 101.5, 99.8, 102.3, 103.1]
        })
        print(f"âœ“ pandas DataFrameåˆ›å»ºæˆåŠŸ: {df.shape}")

        # æµ‹è¯•numpyåŸºç¡€æ“ä½œ
        arr = np.array([1, 2, 3, 4, 5])
        print(f"âœ“ numpyæ•°ç»„æ“ä½œæˆåŠŸ: mean={arr.mean()}")

    except Exception as e:
        print(f"âœ— åŸºç¡€åŠŸèƒ½æµ‹è¯•å¤±è´¥: {e}")

if __name__ == "__main__":
    print("=== ç¯å¢ƒæµ‹è¯•å¼€å§‹ ===")
    test_imports()
    test_basic_functionality()
    print("=== ç¯å¢ƒæµ‹è¯•å®Œæˆ ===")
EOF

# è¿è¡Œæµ‹è¯•è„šæœ¬
python test_environment.py
```

**é¢„æœŸæˆåŠŸè¾“å‡ºï¼š**
```
=== ç¯å¢ƒæµ‹è¯•å¼€å§‹ ===
âœ“ pandas: 2.3.3
âœ“ numpy: 2.3.5
âœ“ akshare: 1.17.87
âœ“ clickhouse_driver: æˆåŠŸå¯¼å…¥
âœ“ pandas DataFrameåˆ›å»ºæˆåŠŸ: (5, 2)
âœ“ numpyæ•°ç»„æ“ä½œæˆåŠŸ: mean=3.0
=== ç¯å¢ƒæµ‹è¯•å®Œæˆ ===
```

### æ­¥éª¤8ï¼šåˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„

```bash
# åˆ›å»ºæ ‡å‡†é¡¹ç›®ç›®å½•ç»“æ„
mkdir -p src/{data,strategies,backtest,execution,utils}
mkdir -p tests/{unit,integration,fixtures}
mkdir -p notebooks
mkdir -p scripts
mkdir -p config
mkdir -p docs
mkdir -p data/{raw,processed,logs}
mkdir -p rust/{src,python/pulse_trader_rust}

# åˆ›å»º__init__.pyæ–‡ä»¶ä½¿ç›®å½•æˆä¸ºPythonåŒ…
touch src/__init__.py
touch src/data/__init__.py
touch src/strategies/__init__.py
touch src/backtest/__init__.py
touch src/execution/__init__.py
touch src/utils/__init__.py
touch tests/__init__.py

# åˆ›å»ºRust-Pythoné›†æˆç›®å½•çš„__init__.py
touch rust/python/pulse_trader_rust/__init__.py

# åˆ›å»ºå ä½æ–‡ä»¶
touch data/raw/.gitkeep
touch data/processed/.gitkeep
touch data/logs/.gitkeep

# éªŒè¯ç›®å½•ç»“æ„
tree -L 2
```

### æ­¥éª¤9ï¼šåˆ›å»ºREADMEæ–‡ä»¶

```bash
cat > README.md << 'EOF'
# PulseTrader - Aè‚¡é‡åŒ–äº¤æ˜“ç³»ç»Ÿ

åŸºäº Rust + Python + ClickHouse + Akshare çš„ç°ä»£åŒ–Aè‚¡é‡åŒ–äº¤æ˜“ç³»ç»Ÿã€‚

## æŠ€æœ¯æ ˆ

- **Python 3.12**: ä¸»è¦å¼€å‘è¯­è¨€
- **Rust**: é«˜æ€§èƒ½è®¡ç®—æ¨¡å—
- **Maturin + PyO3**: ç°ä»£åŒ–Rust-Pythoné›†æˆæ–¹æ¡ˆ
- **ClickHouse**: æ—¶åºæ•°æ®åº“
- **Akshare**: Aè‚¡æ•°æ®æº

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.12+
- Git
- Docker (ç”¨äºClickHouse)

### å®‰è£…æ­¥éª¤

1. å…‹éš†ä»“åº“
```bash
git clone <repository-url>
cd PulseTrader
```

2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
```bash
python3.12 -m venv .venv
source .venv/bin/activate  # Linux/macOS
# æˆ– .venv\Scripts\activate  # Windows
```

3. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

4. è¿è¡Œæµ‹è¯•
```bash
python test_environment.py
```

## é¡¹ç›®ç»“æ„

```
PulseTrader/
â”œâ”€â”€ src/                    # æºä»£ç 
â”‚   â”œâ”€â”€ data/              # æ•°æ®è·å–å’Œå¤„ç†
â”‚   â”œâ”€â”€ strategies/        # äº¤æ˜“ç­–ç•¥
â”‚   â”œâ”€â”€ backtest/          # å›æµ‹å¼•æ“
â”‚   â”œâ”€â”€ execution/         # äº¤æ˜“æ‰§è¡Œ
â”‚   â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”œâ”€â”€ tests/                 # æµ‹è¯•ä»£ç 
â”œâ”€â”€ notebooks/            # Jupyterç¬”è®°æœ¬
â”œâ”€â”€ scripts/              # è„šæœ¬æ–‡ä»¶
â”œâ”€â”€ config/               # é…ç½®æ–‡ä»¶
â”œâ”€â”€ rust/                 # Rusté«˜æ€§èƒ½æ¨¡å—
â”‚   â”œâ”€â”€ src/              # Rustæºä»£ç 
â”‚   â”œâ”€â”€ python/           # Pythonç»‘å®šä»£ç 
â”‚   â””â”€â”€ Cargo.toml        # Rusté¡¹ç›®é…ç½®
â””â”€â”€ data/                 # æ•°æ®æ–‡ä»¶
```

## å¼€å‘è¿›åº¦

- [x] ç¬¬ä¸€ç« ï¼šç¯å¢ƒæ­å»ºä¸é¡¹ç›®åˆå§‹åŒ–
- [ ] ç¬¬äºŒç« ï¼šæ•°æ®è·å–ä¸å­˜å‚¨
- [ ] ç¬¬ä¸‰ç« ï¼šåŸºç¡€æŠ€æœ¯æŒ‡æ ‡å®ç°
- [ ] ç¬¬å››ç« ï¼šç­–ç•¥å¼€å‘æ¡†æ¶
- [ ] ç¬¬äº”ç« ï¼šå›æµ‹ç³»ç»Ÿæ„å»º

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestã€‚

## è®¸å¯è¯

MIT License
EOF
```

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**Q1: `python3.12: command not found`**
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æ˜¯å¦æ­£ç¡®æ·»åŠ åˆ°PATH
echo $PATH | grep python

# å¦‚æœæ²¡æœ‰ï¼Œæ‰‹åŠ¨æ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrc
export PATH="/usr/bin/python3.12:$PATH"
```

**Q2: è™šæ‹Ÿç¯å¢ƒæ¿€æ´»å¤±è´¥**
```bash
# è§£å†³æ–¹æ¡ˆï¼šé‡æ–°åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
rm -rf .venv
python3.12 -m venv .venv
source .venv/bin/activate
```

**Q3: pipå®‰è£…ä¾èµ–å¤±è´¥**
```bash
# è§£å†³æ–¹æ¡ˆï¼šå‡çº§pipå¹¶ä½¿ç”¨å›½å†…é•œåƒ
pip install --upgrade pip
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pandas numpy
```

**Q4: VS Codeæ— æ³•è¯†åˆ«è™šæ‹Ÿç¯å¢ƒ**
```bash
# è§£å†³æ–¹æ¡ˆï¼šåœ¨VS Codeä¸­é‡æ–°é€‰æ‹©Pythonè§£é‡Šå™¨
# æŒ‰ Ctrl+Shift+Pï¼Œè¾“å…¥ "Python: Select Interpreter"
# é€‰æ‹© ./.venv/bin/python
```

### æ­¥éª¤10ï¼šåˆ›å»ºRusté›†æˆåŸºç¡€æ–‡ä»¶

ä¸ºåç»­çš„Rusté«˜æ€§èƒ½æ¨¡å—åšå‡†å¤‡ï¼Œåˆ›å»ºåŸºç¡€çš„Rusté¡¹ç›®æ–‡ä»¶ï¼š

```bash
# åˆ›å»ºRusté¡¹ç›®é…ç½®æ–‡ä»¶
cat > rust/Cargo.toml << 'EOF'
[package]
name = "pulse-trader-rust"
version = "0.1.0"
edition = "2021"

[lib]
name = "pulse_trader_rust"
crate-type = ["cdylib"]

[dependencies]
pyo3 = { version = "0.22", features = ["extension-module"] }
numpy = "0.21"
polars = { version = "0.42", features = ["lazy"] }
tokio = { version = "1.0", features = ["full"] }
serde = { version = "1.0", features = ["derive"] }
EOF

# åˆ›å»ºåŸºç¡€Ruståº“æ–‡ä»¶
cat > rust/src/lib.rs << 'EOF'
use pyo3::prelude::*;

/// Pythonæ¨¡å—å®šä¹‰
#[pymodule]
fn pulse_trader_rust(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add("__version__", env!("CARGO_PKG_VERSION"))?;
    m.add("__author__", "PulseTrader Team")?;
    Ok(())
}
EOF
```

### å…³äºMaturin + PyO3çš„è¯´æ˜

**ä¸ºä»€ä¹ˆé€‰æ‹©Maturinï¼Ÿ**

1. **ç®€åŒ–æ„å»º**: Maturinè‡ªåŠ¨å¤„ç†å¤æ‚çš„Rust-Pythonç»‘å®šè¿‡ç¨‹
2. **æ— ç¼é›†æˆ**: ä¸pipã€poetryç­‰PythonåŒ…ç®¡ç†å·¥å…·å®Œç¾é…åˆ
3. **é«˜æ€§èƒ½**: åŸºäºPyO3ï¼Œæä¾›æ¥è¿‘åŸç”ŸCçš„æ€§èƒ½
4. **å¼€å‘å‹å¥½**: æ”¯æŒçƒ­é‡è½½ï¼Œè°ƒè¯•æ›´æ–¹ä¾¿

**Maturinå·¥ä½œæµç¨‹ï¼š**
```bash
# å¼€å‘æ¨¡å¼ç¼–è¯‘ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
maturin develop

# ç”Ÿäº§æ¨¡å¼æ„å»º
maturin build --release

# å‘å¸ƒåˆ°PyPI
maturin publish
```

è¿™ä¸ªç»„åˆå°†åœ¨ç¬¬ä¸‰ç« è¯¦ç»†è®²è§£ï¼Œç°åœ¨æˆ‘ä»¬å…ˆå‡†å¤‡å¥½åŸºç¡€ç¯å¢ƒã€‚

### æœ¬èŠ‚å°ç»“

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸå®Œæˆäº†Python 3.12å¼€å‘ç¯å¢ƒçš„é…ç½®ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‚¨å­¦ä¼šäº†ï¼š

1. âœ… å®‰è£…Python 3.12æœ€æ–°ç¨³å®šç‰ˆ
2. âœ… åˆ›å»ºå’Œé…ç½®è™šæ‹Ÿç¯å¢ƒ
3. âœ… å®‰è£…å’Œé…ç½®ä¸“ä¸šå¼€å‘å·¥å…·
4. âœ… åˆ›å»ºæ ‡å‡†åŒ–çš„é¡¹ç›®ç»“æ„
5. âœ… éªŒè¯ç¯å¢ƒé…ç½®æ­£ç¡®æ€§

**ä¸‹ä¸€æ­¥ï¼š** å®Œæˆç¯å¢ƒé…ç½®åï¼Œæ‚¨å°†åœ¨ä¸‹ä¸€èŠ‚å­¦ä¹ å¦‚ä½•å®‰è£…å’Œé…ç½®ClickHouseæ•°æ®åº“ï¼Œä¸ºå­˜å‚¨è‚¡ç¥¨æ•°æ®åšå¥½å‡†å¤‡ã€‚

---

## 1.2 ClickHouseæ•°æ®åº“å®‰è£…ä¸é…ç½®

### å­¦ä¹ ç›®æ ‡
- ä½¿ç”¨Dockeréƒ¨ç½²ClickHouseæ•°æ®åº“
- é…ç½®é€‚åˆAè‚¡é‡åŒ–äº¤æ˜“çš„æ•°æ®è¡¨ç»“æ„
- å»ºç«‹Python-ClickHouseè¿æ¥
- éªŒè¯æ•°æ®åº“å®‰è£…å’Œæ•°æ®æ“ä½œ

### é¢„è®¡å®Œæˆæ—¶é—´
20-25åˆ†é’Ÿ

---

### æ­¥éª¤1ï¼šDockerç¯å¢ƒå‡†å¤‡

é¦–å…ˆç¡®ä¿Dockerç¯å¢ƒæ­£å¸¸å·¥ä½œï¼š

```bash
# æ£€æŸ¥Dockerå®‰è£…çŠ¶æ€
docker --version
docker-compose --version

# å¦‚æœæœªå®‰è£…Dockerï¼Œåœ¨Ubuntu/WSL2ä¸Šå®‰è£…ï¼š
sudo apt update
sudo apt install docker.io docker-compose-plugin

# å¯åŠ¨DockeræœåŠ¡
sudo systemctl start docker
sudo systemctl enable docker

# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç»„ï¼ˆé¿å…æ¯æ¬¡ä½¿ç”¨sudoï¼‰
sudo usermod -aG docker $USER
newgrp docker

# éªŒè¯Dockeræ˜¯å¦æ­£å¸¸å·¥ä½œ
docker run hello-world
```

**é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š**
```
Hello from Docker!
This message shows that your installation appears to be working correctly.
```

### æ­¥éª¤2ï¼šåˆ›å»ºClickHouseé…ç½®æ–‡ä»¶

#### 2.1 åˆ›å»ºdocker-composeé…ç½®

```bash
# åˆ›å»ºdocker-compose.ymlæ–‡ä»¶
cat > docker-compose.yml << 'EOF'
version: '3.8'

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.3.8.43
    container_name: pulse-trader-clickhouse
    hostname: clickhouse
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native interface
    volumes:
      - ./config/clickhouse:/etc/clickhouse-server/config.d
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    environment:
      CLICKHOUSE_DB: pulse_trader
      CLICKHOUSE_USER: quant_user
      CLICKHOUSE_PASSWORD: Quant@2024
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    networks:
      - quant_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  redis:
    image: redis:7.2-alpine
    container_name: pulse-trader-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - quant_network
    command: redis-server --appendonly yes

volumes:
  clickhouse_data:
  clickhouse_logs:
  redis_data:

networks:
  quant_network:
    driver: bridge
EOF
```

#### 2.2 åˆ›å»ºClickHouseæ€§èƒ½ä¼˜åŒ–é…ç½®

```bash
# åˆ›å»ºé…ç½®ç›®å½•
mkdir -p config/clickhouse

# åˆ›å»ºæ€§èƒ½ä¼˜åŒ–é…ç½®
cat > config/clickhouse/quant_optimization.xml << 'EOF'
<?xml version="1.0"?>
<clickhouse>
    <!-- å†…å­˜é…ç½® -->
    <max_memory_usage>10000000000</max_memory_usage>
    <max_bytes_before_external_group_by>10000000000</max_bytes_before_external_group_by>

    <!-- å¹¶å‘é…ç½® -->
    <max_threads>8</max_threads>
    <max_insert_threads>4</max_insert_threads>

    <!-- åˆå¹¶æ ‘ä¼˜åŒ– -->
    <merge_tree>
        <max_suspicious_broken_parts>5</max_suspicious_broken_parts>
        <parts_to_delay_insert>150</parts_to_delay_insert>
        <parts_to_throw_insert>300</parts_to_throw_insert>
        <max_bytes_to_merge_at_max_space_in_pool>1048576000</max_bytes_to_merge_at_max_space_in_pool>
    </merge_tree>

    <!-- æ—¥å¿—é…ç½® -->
    <logger>
        <level>warning</level>
        <console>true</console>
        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
    </logger>

    <!-- æ—¶åŒºè®¾ç½® -->
    <timezone>Asia/Shanghai</timezone>
</clickhouse>
EOF
```

### æ­¥éª¤3ï¼šå¯åŠ¨ClickHouseæœåŠ¡

```bash
# å¯åŠ¨ClickHouseå’ŒRedisæœåŠ¡
docker-compose up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆ
echo "ç­‰å¾…ClickHouseæœåŠ¡å¯åŠ¨..."
sleep 30

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æ£€æŸ¥ClickHouseæœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:8123/ping

# é¢„æœŸè¾“å‡ºåº”è¯¥æ˜¯ "OK."
```

**å¦‚æœæœåŠ¡çŠ¶æ€æ˜¾ç¤ºhealthyï¼Œè¯´æ˜å¯åŠ¨æˆåŠŸï¼**

### æ­¥éª¤4ï¼šåˆ›å»ºAè‚¡æ•°æ®è¡¨ç»“æ„

#### 4.1 åˆ›å»ºSQLè„šæœ¬æ–‡ä»¶

```bash
# åˆ›å»ºSQLè„šæœ¬ç›®å½•
mkdir -p scripts/database

# åˆ›å»ºAè‚¡æ•°æ®è¡¨ç»“æ„è„šæœ¬
cat > scripts/database/create_tables.sql << 'EOF'
-- PulseTrader Aè‚¡é‡åŒ–äº¤æ˜“æ•°æ®åº“è¡¨ç»“æ„

-- ä½¿ç”¨ä¸“é—¨çš„æ•°æ®åº“
USE pulse_trader;

-- 1. è‚¡ç¥¨åŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE IF NOT EXISTS stock_info (
    symbol String,           -- è‚¡ç¥¨ä»£ç  (å¦‚: 000001.SZ)
    name String,             -- è‚¡ç¥¨åç§°
    market String,           -- å¸‚åœº (SH/SZ/BJ)
    industry String,         -- è¡Œä¸š
    sector String,           -- æ¿å—
    list_date Date,          -- ä¸Šå¸‚æ—¥æœŸ
    delist_date Nullable(Date), -- é€€å¸‚æ—¥æœŸ
    is_active UInt8 DEFAULT 1,
    created_at DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY market
ORDER BY (symbol, created_at);

-- 2. æ—¥çº¿è¡Œæƒ…æ•°æ®è¡¨ (Aè‚¡ä¸“ç”¨)
CREATE TABLE IF NOT EXISTS stock_daily (
    symbol String,           -- è‚¡ç¥¨ä»£ç 
    trade_date Date,         -- äº¤æ˜“æ—¥æœŸ
    open Decimal(18, 4),     -- å¼€ç›˜ä»·
    high Decimal(18, 4),     -- æœ€é«˜ä»·
    low Decimal(18, 4),      -- æœ€ä½ä»·
    close Decimal(18, 4),    -- æ”¶ç›˜ä»·
    volume UInt64,           -- æˆäº¤é‡(è‚¡)
    amount Decimal(18, 2),   -- æˆäº¤é¢(å…ƒ)
    turnover_rate Decimal(8, 4), -- æ¢æ‰‹ç‡
    pe_ratio Decimal(10, 4), -- å¸‚ç›ˆç‡
    pb_ratio Decimal(10, 4), -- å¸‚å‡€ç‡
    cap_total Decimal(18, 2), -- æ€»å¸‚å€¼
    cap_flow Decimal(18, 2),  -- æµé€šå¸‚å€¼
    limit_up UInt8 DEFAULT 0, -- æ¶¨åœæ ‡è®°
    limit_down UInt8 DEFAULT 0, -- è·Œåœæ ‡è®°
    created_at DateTime DEFAULT now()
) ENGINE = ReplacingMergeTree()
PARTITION BY toYYYYMM(trade_date)
ORDER BY (symbol, trade_date);

-- 3. åˆ†é’Ÿçº¿æ•°æ®è¡¨ (ç”¨äºé«˜é¢‘ç­–ç•¥)
CREATE TABLE IF NOT EXISTS stock_1min (
    symbol String,           -- è‚¡ç¥¨ä»£ç 
    datetime DateTime,       -- æ—¶é—´æˆ³
    open Decimal(18, 4),     -- å¼€ç›˜ä»·
    high Decimal(18, 4),     -- æœ€é«˜ä»·
    low Decimal(18, 4),      -- æœ€ä½ä»·
    close Decimal(18, 4),    -- æ”¶ç›˜ä»·
    volume UInt64,           -- æˆäº¤é‡
    amount Decimal(18, 2),   -- æˆäº¤é¢
    created_at DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMMDD(datetime)
ORDER BY (symbol, datetime);

-- 4. æŠ€æœ¯æŒ‡æ ‡è¡¨
CREATE TABLE IF NOT EXISTS stock_indicators (
    symbol String,           -- è‚¡ç¥¨ä»£ç 
    trade_date Date,         -- äº¤æ˜“æ—¥æœŸ
    indicator_name String,   -- æŒ‡æ ‡åç§°
    indicator_value Decimal(18, 6), -- æŒ‡æ ‡å€¼
    period_param UInt16,     -- å‚æ•°å‘¨æœŸ
    created_at DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY (indicator_name, toYYYYMM(trade_date))
ORDER BY (symbol, trade_date, indicator_name);

-- 5. äº¤æ˜“ä¿¡å·è¡¨
CREATE TABLE IF NOT EXISTS trading_signals (
    signal_id UUID,          -- ä¿¡å·ID
    symbol String,           -- è‚¡ç¥¨ä»£ç 
    strategy_name String,    -- ç­–ç•¥åç§°
    signal_type String,      -- ä¿¡å·ç±»å‹ (BUY/SELL/HOLD)
    signal_time DateTime,    -- ä¿¡å·æ—¶é—´
    price Decimal(18, 4),    -- è§¦å‘ä»·æ ¼
    confidence Decimal(5, 4), -- ç½®ä¿¡åº¦
    reason String,           -- ä¿¡å·åŸå› 
    created_at DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(signal_time)
ORDER BY (strategy_name, symbol, signal_time);

-- 6. å›æµ‹ç»“æœè¡¨
CREATE TABLE IF NOT EXISTS backtest_results (
    result_id UUID,          -- ç»“æœID
    strategy_name String,    -- ç­–ç•¥åç§°
    start_date Date,         -- å¼€å§‹æ—¥æœŸ
    end_date Date,           -- ç»“æŸæ—¥æœŸ
    initial_capital Decimal(18, 2), -- åˆå§‹èµ„é‡‘
    final_capital Decimal(18, 2),   -- æœ€ç»ˆèµ„é‡‘
    total_return Decimal(8, 4),      -- æ€»æ”¶ç›Šç‡
    annual_return Decimal(8, 4),     -- å¹´åŒ–æ”¶ç›Šç‡
    max_drawdown Decimal(8, 4),      -- æœ€å¤§å›æ’¤
    sharpe_ratio Decimal(8, 4),      -- å¤æ™®æ¯”ç‡
    win_rate Decimal(5, 4),          -- èƒœç‡
    profit_loss_ratio Decimal(8, 4), -- ç›ˆäºæ¯”
    total_trades UInt32,             -- æ€»äº¤æ˜“æ¬¡æ•°
    created_at DateTime DEFAULT now()
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(created_at)
ORDER BY (strategy_name, created_at);

-- åˆ›å»ºè§†å›¾ï¼šæœ€æ–°è‚¡ç¥¨ä»·æ ¼
CREATE VIEW IF NOT EXISTS v_latest_price AS
SELECT
    symbol,
    trade_date,
    close as latest_price,
    volume,
    amount,
    turnover_rate
FROM stock_daily
WHERE trade_date = (
    SELECT MAX(trade_date)
    FROM stock_daily
    WHERE stock_daily.symbol = stock_daily.symbol
);

-- æ’å…¥ä¸€äº›æµ‹è¯•æ•°æ®
INSERT INTO stock_info (symbol, name, market, industry, list_date) VALUES
('000001.SZ', 'å¹³å®‰é“¶è¡Œ', 'SZ', 'é“¶è¡Œ', '1991-04-03'),
('000002.SZ', 'ä¸‡ç§‘A', 'SZ', 'æˆ¿åœ°äº§', '1991-01-29'),
('600000.SH', 'æµ¦å‘é“¶è¡Œ', 'SH', 'é“¶è¡Œ', '1999-11-10'),
('600036.SH', 'æ‹›å•†é“¶è¡Œ', 'SH', 'é“¶è¡Œ', '2002-04-09');

-- æŸ¥çœ‹åˆ›å»ºçš„è¡¨
SHOW TABLES;
EOF
```

#### 4.2 æ‰§è¡ŒSQLè„šæœ¬

```bash
# æ‰§è¡Œè¡¨åˆ›å»ºè„šæœ¬
docker exec pulse-trader-clickhouse clickhouse-client \
  --user quant_user \
  --password Quant@2024 \
  --database pulse_trader \
  --queries-file scripts/database/create_tables.sql

# éªŒè¯è¡¨åˆ›å»ºç»“æœ
docker exec pulse-trader-clickhouse clickhouse-client \
  --user quant_user \
  --password Quant@2024 \
  --database pulse_trader \
  --query "SHOW TABLES"
```

**é¢„æœŸè¾“å‡ºåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰åˆ›å»ºçš„è¡¨åç§°ã€‚**

### æ­¥éª¤5ï¼šPython-ClickHouseè¿æ¥é…ç½®

#### 5.1 å®‰è£…Pythonå®¢æˆ·ç«¯

```bash
# ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
source .venv/bin/activate

# å®‰è£…ClickHouse Pythonå®¢æˆ·ç«¯å’Œç›¸å…³åº“
pip install clickhouse-driver clickhouse-pool redis pandas

# éªŒè¯å®‰è£…
python -c "import clickhouse_driver; print('ClickHouse driver installed successfully')"
```

#### 5.2 åˆ›å»ºæ•°æ®åº“è¿æ¥ç±»

```bash
# åˆ›å»ºæ•°æ®åº“æ“ä½œæ¨¡å—ç›®å½•
mkdir -p src/data

# åˆ›å»ºæ•°æ®åº“è¿æ¥å’Œæ“ä½œç±»
cat > src/data/database.py << 'EOF'
"""
ClickHouseæ•°æ®åº“æ“ä½œç±»
æä¾›è¿æ¥ç®¡ç†ã€æ•°æ®æŸ¥è¯¢å’Œæ’å…¥åŠŸèƒ½
"""

import logging
from typing import List, Dict, Any, Optional
from clickhouse_driver import Client
from clickhouse_pool import ChPool
import redis
import pandas as pd
from datetime import datetime, date
import json

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class ClickHouseManager:
    """ClickHouseæ•°æ®åº“ç®¡ç†å™¨"""

    def __init__(self, host='localhost', port=8123,
                 user='quant_user', password='Quant@2024',
                 database='pulse_trader'):
        """åˆå§‹åŒ–ClickHouseè¿æ¥"""
        self.host = host
        self.port = port
        self.user = user
        self.password = password
        self.database = database

        # åˆ›å»ºè¿æ¥æ± 
        self.pool = ChPool(
            host=host,
            port=port,
            user=user,
            password=password,
            database=database,
            connections_min=5,
            connections_max=20
        )

        # Redisç¼“å­˜è¿æ¥
        self.redis_client = redis.Redis(host='localhost', port=6379, db=0)

        # å•ä¾‹è¿æ¥ï¼ˆç”¨äºå¤æ‚æŸ¥è¯¢ï¼‰
        self.client = Client(
            host=host,
            port=port,
            user=user,
            password=password,
            database=database
        )

        logger.info("ClickHouseè¿æ¥åˆå§‹åŒ–å®Œæˆ")

    def test_connection(self) -> bool:
        """æµ‹è¯•æ•°æ®åº“è¿æ¥"""
        try:
            result = self.client.execute('SELECT 1')
            if result[0][0] == 1:
                logger.info("ClickHouseè¿æ¥æµ‹è¯•æˆåŠŸ")
                return True
        except Exception as e:
            logger.error(f"ClickHouseè¿æ¥æµ‹è¯•å¤±è´¥: {e}")
            return False

    def execute_query(self, query: str, params: Dict = None) -> Any:
        """æ‰§è¡ŒæŸ¥è¯¢"""
        try:
            with self.pool.get_client() as client:
                if params:
                    return client.execute(query, params)
                else:
                    return client.execute(query)
        except Exception as e:
            logger.error(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {e}, SQL: {query}")
            raise

    def insert_daily_data(self, data: List[Dict]) -> bool:
        """æ’å…¥æ—¥çº¿æ•°æ®"""
        try:
            columns = [
                'symbol', 'trade_date', 'open', 'high', 'low', 'close',
                'volume', 'amount', 'turnover_rate', 'pe_ratio', 'pb_ratio',
                'cap_total', 'cap_flow', 'limit_up', 'limit_down'
            ]

            # è¿‡æ»¤å’Œå‡†å¤‡æ•°æ®
            insert_data = []
            for row in data:
                insert_data.append([
                    row.get('symbol'),
                    row.get('trade_date'),
                    float(row.get('open', 0)),
                    float(row.get('high', 0)),
                    float(row.get('low', 0)),
                    float(row.get('close', 0)),
                    int(row.get('volume', 0)),
                    float(row.get('amount', 0)),
                    float(row.get('turnover_rate', 0)),
                    float(row.get('pe_ratio', 0)),
                    float(row.get('pb_ratio', 0)),
                    float(row.get('cap_total', 0)),
                    float(row.get('cap_flow', 0)),
                    int(row.get('limit_up', 0)),
                    int(row.get('limit_down', 0))
                ])

            # æ‰§è¡Œæ‰¹é‡æ’å…¥
            query = f"""
                INSERT INTO stock_daily ({', '.join(columns)})
                VALUES
            """

            with self.pool.get_client() as client:
                client.execute(query, insert_data)

            logger.info(f"æˆåŠŸæ’å…¥ {len(insert_data)} æ¡æ—¥çº¿æ•°æ®")
            return True

        except Exception as e:
            logger.error(f"æ’å…¥æ—¥çº¿æ•°æ®å¤±è´¥: {e}")
            return False

    def get_stock_daily(self, symbol: str, start_date: date,
                       end_date: date) -> pd.DataFrame:
        """è·å–æŒ‡å®šè‚¡ç¥¨çš„æ—¥çº¿æ•°æ®"""
        try:
            # æ£€æŸ¥ç¼“å­˜
            cache_key = f"stock_daily:{symbol}:{start_date}:{end_date}"
            cached_data = self.redis_client.get(cache_key)

            if cached_data:
                logger.info(f"ä»ç¼“å­˜è·å– {symbol} æ—¥çº¿æ•°æ®")
                return pd.read_json(cached_data)

            # ä»æ•°æ®åº“æŸ¥è¯¢
            query = """
                SELECT symbol, trade_date, open, high, low, close,
                       volume, amount, turnover_rate, pe_ratio, pb_ratio
                FROM stock_daily
                WHERE symbol = %(symbol)s
                  AND trade_date BETWEEN %(start_date)s AND %(end_date)s
                ORDER BY trade_date
            """

            params = {
                'symbol': symbol,
                'start_date': start_date,
                'end_date': end_date
            }

            result = self.client.execute(query, params)

            # è½¬æ¢ä¸ºDataFrame
            columns = ['symbol', 'trade_date', 'open', 'high', 'low', 'close',
                      'volume', 'amount', 'turnover_rate', 'pe_ratio', 'pb_ratio']
            df = pd.DataFrame(result, columns=columns)

            # ç¼“å­˜ç»“æœï¼ˆ1å°æ—¶ï¼‰
            self.redis_client.setex(cache_key, 3600, df.to_json())

            logger.info(f"æŸ¥è¯¢åˆ° {len(df)} æ¡ {symbol} æ—¥çº¿æ•°æ®")
            return df

        except Exception as e:
            logger.error(f"æŸ¥è¯¢æ—¥çº¿æ•°æ®å¤±è´¥: {e}")
            return pd.DataFrame()

    def get_latest_price(self, symbol: str = None) -> pd.DataFrame:
        """è·å–æœ€æ–°ä»·æ ¼æ•°æ®"""
        try:
            if symbol:
                query = """
                    SELECT * FROM v_latest_price
                    WHERE symbol = %(symbol)s
                """
                params = {'symbol': symbol}
            else:
                query = "SELECT * FROM v_latest_price LIMIT 100"
                params = {}

            result = self.client.execute(query, params)
            columns = ['symbol', 'trade_date', 'latest_price', 'volume', 'amount', 'turnover_rate']
            df = pd.DataFrame(result, columns=columns)

            return df

        except Exception as e:
            logger.error(f"æŸ¥è¯¢æœ€æ–°ä»·æ ¼å¤±è´¥: {e}")
            return pd.DataFrame()

    def get_stock_info(self, symbol: str = None) -> pd.DataFrame:
        """è·å–è‚¡ç¥¨åŸºç¡€ä¿¡æ¯"""
        try:
            if symbol:
                query = """
                    SELECT * FROM stock_info
                    WHERE symbol = %(symbol)s AND is_active = 1
                """
                params = {'symbol': symbol}
            else:
                query = """
                    SELECT * FROM stock_info
                    WHERE is_active = 1
                    ORDER BY symbol
                """
                params = {}

            result = self.client.execute(query, params)
            columns = ['symbol', 'name', 'market', 'industry', 'sector',
                      'list_date', 'delist_date', 'is_active', 'created_at']
            df = pd.DataFrame(result, columns=columns)

            return df

        except Exception as e:
            logger.error(f"æŸ¥è¯¢è‚¡ç¥¨ä¿¡æ¯å¤±è´¥: {e}")
            return pd.DataFrame()

    def close(self):
        """å…³é—­è¿æ¥"""
        if hasattr(self, 'pool'):
            self.pool.close()
        if hasattr(self, 'redis_client'):
            self.redis_client.close()
        logger.info("ClickHouseè¿æ¥å·²å…³é—­")

# åˆ›å»ºå…¨å±€æ•°æ®åº“ç®¡ç†å™¨å®ä¾‹
db_manager = ClickHouseManager()

# æµ‹è¯•å‡½æ•°
def test_database_connection():
    """æµ‹è¯•æ•°æ®åº“è¿æ¥å’ŒåŸºç¡€æ“ä½œ"""
    try:
        # æµ‹è¯•è¿æ¥
        if not db_manager.test_connection():
            return False

        # æµ‹è¯•æŸ¥è¯¢
        stock_info = db_manager.get_stock_info()
        logger.info(f"æŸ¥è¯¢åˆ° {len(stock_info)} åªè‚¡ç¥¨")

        # æµ‹è¯•æœ€æ–°ä»·æ ¼
        latest_price = db_manager.get_latest_price()
        logger.info(f"æŸ¥è¯¢åˆ° {len(latest_price)} æ¡æœ€æ–°ä»·æ ¼è®°å½•")

        return True

    except Exception as e:
        logger.error(f"æ•°æ®åº“æµ‹è¯•å¤±è´¥: {e}")
        return False

if __name__ == "__main__":
    test_database_connection()
EOF
```

### æ­¥éª¤6ï¼šéªŒè¯æ•°æ®åº“åŠŸèƒ½

#### 6.1 åˆ›å»ºæµ‹è¯•è„šæœ¬

```bash
# åˆ›å»ºæ•°æ®åº“æµ‹è¯•è„šæœ¬
cat > test_clickhouse.py << 'EOF'
#!/usr/bin/env python3
"""
ClickHouseæ•°æ®åº“åŠŸèƒ½æµ‹è¯•è„šæœ¬
éªŒè¯æ•°æ®åº“è¿æ¥ã€æŸ¥è¯¢å’ŒåŸºç¡€æ“ä½œ
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

from src.data.database import db_manager, test_database_connection
import pandas as pd
from datetime import datetime, date

def test_basic_operations():
    """æµ‹è¯•åŸºç¡€æ•°æ®åº“æ“ä½œ"""
    print("=== ClickHouseæ•°æ®åº“åŠŸèƒ½æµ‹è¯• ===")

    # 1. æµ‹è¯•è¿æ¥
    print("\n1. æµ‹è¯•æ•°æ®åº“è¿æ¥...")
    if test_database_connection():
        print("âœ“ æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡")
    else:
        print("âœ— æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥")
        return False

    # 2. æµ‹è¯•è‚¡ç¥¨ä¿¡æ¯æŸ¥è¯¢
    print("\n2. æµ‹è¯•è‚¡ç¥¨ä¿¡æ¯æŸ¥è¯¢...")
    try:
        stock_info = db_manager.get_stock_info()
        print(f"âœ“ æŸ¥è¯¢åˆ° {len(stock_info)} åªè‚¡ç¥¨")
        if len(stock_info) > 0:
            print("  ç¤ºä¾‹è‚¡ç¥¨ä¿¡æ¯:")
            print(stock_info.head(2).to_string(index=False))
    except Exception as e:
        print(f"âœ— è‚¡ç¥¨ä¿¡æ¯æŸ¥è¯¢å¤±è´¥: {e}")
        return False

    # 3. æµ‹è¯•æ—¥çº¿æ•°æ®æŸ¥è¯¢
    print("\n3. æµ‹è¯•æ—¥çº¿æ•°æ®æŸ¥è¯¢...")
    try:
        # ç”±äºæˆ‘ä»¬è¿˜æ²¡æœ‰çœŸå®æ•°æ®ï¼Œè¿™ä¸ªæŸ¥è¯¢ä¼šè¿”å›ç©ºç»“æœ
        test_data = db_manager.get_stock_daily(
            symbol='000001.SZ',
            start_date=date(2024, 1, 1),
            end_date=date(2024, 12, 31)
        )
        print(f"âœ“ æ—¥çº¿æ•°æ®æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸ï¼Œè¿”å› {len(test_data)} æ¡è®°å½•")
    except Exception as e:
        print(f"âœ— æ—¥çº¿æ•°æ®æŸ¥è¯¢å¤±è´¥: {e}")
        return False

    # 4. æµ‹è¯•æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
    print("\n4. æµ‹è¯•æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯...")
    try:
        # æŸ¥è¯¢æ•°æ®åº“ç»Ÿè®¡
        stats_query = """
        SELECT
            'stock_info' as table_name, count() as record_count FROM stock_info
        UNION ALL
        SELECT
            'stock_daily' as table_name, count() as record_count FROM stock_daily
        """
        result = db_manager.execute_query(stats_query)

        print("  æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯:")
        for table_name, count in result:
            print(f"    {table_name}: {count} æ¡è®°å½•")

        print("âœ“ æ•°æ®åº“ç»Ÿè®¡æŸ¥è¯¢æˆåŠŸ")
    except Exception as e:
        print(f"âœ— æ•°æ®åº“ç»Ÿè®¡æŸ¥è¯¢å¤±è´¥: {e}")
        return False

    print("\n=== æ•°æ®åº“åŠŸèƒ½æµ‹è¯•å®Œæˆ ===")
    return True

def test_performance():
    """æµ‹è¯•æ•°æ®åº“æ€§èƒ½"""
    print("\n=== æ•°æ®åº“æ€§èƒ½æµ‹è¯• ===")

    try:
        # æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
        import time
        start_time = time.time()

        # æ‰§è¡Œå¤æ‚æŸ¥è¯¢
        perf_query = """
        SELECT
            market,
            COUNT() as stock_count,
            COUNT(DISTINCT industry) as industry_count
        FROM stock_info
        WHERE is_active = 1
        GROUP BY market
        ORDER BY stock_count DESC
        """

        result = db_manager.execute_query(perf_query)
        query_time = time.time() - start_time

        print(f"âœ“ å¤æ‚æŸ¥è¯¢æ‰§è¡Œæ—¶é—´: {query_time:.4f} ç§’")
        print("  å¸‚åœºç»Ÿè®¡:")
        for market, count, industry_count in result:
            print(f"    {market}: {count} åªè‚¡ç¥¨, {industry_count} ä¸ªè¡Œä¸š")

        # æµ‹è¯•Redisç¼“å­˜æ€§èƒ½
        start_time = time.time()
        redis_result = db_manager.get_stock_info()
        cache_time = time.time() - start_time

        print(f"âœ“ Redisç¼“å­˜æŸ¥è¯¢æ—¶é—´: {cache_time:.4f} ç§’")

    except Exception as e:
        print(f"âœ— æ€§èƒ½æµ‹è¯•å¤±è´¥: {e}")
        return False

    return True

def cleanup():
    """æ¸…ç†èµ„æº"""
    print("\næ¸…ç†æ•°æ®åº“è¿æ¥...")
    try:
        db_manager.close()
        print("âœ“ æ•°æ®åº“è¿æ¥å·²å…³é—­")
    except Exception as e:
        print(f"âœ— æ¸…ç†å¤±è´¥: {e}")

if __name__ == "__main__":
    success = True

    # æ‰§è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•
    if not test_basic_operations():
        success = False

    # æ‰§è¡Œæ€§èƒ½æµ‹è¯•
    if not test_performance():
        success = False

    # æ¸…ç†èµ„æº
    cleanup()

    if success:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ClickHouseæ•°æ®åº“é…ç½®å®Œæˆã€‚")
        sys.exit(0)
    else:
        print("\nâŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚")
        sys.exit(1)
EOF
```

#### 6.2 æ‰§è¡Œæµ‹è¯•è„šæœ¬

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python test_clickhouse.py
```

**é¢„æœŸæˆåŠŸè¾“å‡ºï¼š**
```
=== ClickHouseæ•°æ®åº“åŠŸèƒ½æµ‹è¯• ===

1. æµ‹è¯•æ•°æ®åº“è¿æ¥...
âœ“ æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡

2. æµ‹è¯•è‚¡ç¥¨ä¿¡æ¯æŸ¥è¯¢...
âœ“ æŸ¥è¯¢åˆ° 4 åªè‚¡ç¥¨
  ç¤ºä¾‹è‚¡ç¥¨ä¿¡æ¯:
    symbol    name market industry   list_date delist_date is_active                 created_at
  000001.SZ å¹³å®‰é“¶è¡Œ      SZ      é“¶è¡Œ 1991-04-03        None          1 2024-11-24 12:00:00

3. æµ‹è¯•æ—¥çº¿æ•°æ®æŸ¥è¯¢...
âœ“ æ—¥çº¿æ•°æ®æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸ï¼Œè¿”å› 0 æ¡è®°å½•

4. æµ‹è¯•æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯...
  æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯:
    stock_info: 4 æ¡è®°å½•
    stock_daily: 0 æ¡è®°å½•
âœ“ æ•°æ®åº“ç»Ÿè®¡æŸ¥è¯¢æˆåŠŸ

=== æ•°æ®åº“åŠŸèƒ½æµ‹è¯•å®Œæˆ ===

=== æ•°æ®åº“æ€§èƒ½æµ‹è¯• ===
âœ“ å¤æ‚æŸ¥è¯¢æ‰§è¡Œæ—¶é—´: 0.0023 ç§’
  å¸‚åœºç»Ÿè®¡:
    SZ: 2 åªè‚¡ç¥¨, 2 ä¸ªè¡Œä¸š
    SH: 2 åªè‚¡ç¥¨, 1 ä¸ªè¡Œä¸š
âœ“ Redisç¼“å­˜æŸ¥è¯¢æ—¶é—´: 0.0001 ç§’

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ClickHouseæ•°æ®åº“é…ç½®å®Œæˆã€‚
```

### æ­¥éª¤7ï¼šå¸¸ç”¨æ•°æ®åº“æ“ä½œå‘½ä»¤

```bash
# æŸ¥çœ‹ClickHouseæœåŠ¡çŠ¶æ€
docker-compose ps clickhouse

# æŸ¥çœ‹ClickHouseæ—¥å¿—
docker-compose logs -f clickhouse

# è¿›å…¥ClickHouseå®¢æˆ·ç«¯
docker exec -it pulse-trader-clickhouse clickhouse-client \
  --user quant_user \
  --password Quant@2024 \
  --database pulse_trader

# é‡å¯ClickHouseæœåŠ¡
docker-compose restart clickhouse

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬æ•°æ®å·ï¼‰
docker-compose down -v
```

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

**Q1: Dockerå¯åŠ¨å¤±è´¥**
```bash
# æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€
sudo systemctl status docker

# é‡å¯DockeræœåŠ¡
sudo systemctl restart docker

# æ¸…ç†Dockerèµ„æº
docker system prune -f
```

**Q2: ClickHouseè¿æ¥è¶…æ—¶**
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tulpn | grep 8123

# ä¿®æ”¹docker-compose.ymlä¸­çš„ç«¯å£æ˜ å°„
# ä¾‹å¦‚æ”¹ä¸º 8124:8123
```

**Q3: å†…å­˜ä¸è¶³é”™è¯¯**
```bash
# å¢åŠ Dockerå†…å­˜é™åˆ¶
# åœ¨docker-compose.ymlä¸­æ·»åŠ :
# deploy:
#   resources:
#     limits:
#       memory: 2G
```

**Q4: æƒé™è®¿é—®é”™è¯¯**
```bash
# é‡æ–°åˆ›å»ºç”¨æˆ·æƒé™
docker exec pulse-trader-clickhouse clickhouse-client \
  --query "GRANT ALL ON pulse_trader.* TO quant_user"
```

### æœ¬èŠ‚å°ç»“

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸå®Œæˆäº†ClickHouseæ•°æ®åº“çš„å®‰è£…å’Œé…ç½®ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‚¨å­¦ä¼šäº†ï¼š

1. âœ… ä½¿ç”¨Dockeréƒ¨ç½²ClickHouseæ•°æ®åº“
2. âœ… é…ç½®Aè‚¡ä¸“ç”¨æ•°æ®è¡¨ç»“æ„
3. âœ… å»ºç«‹Python-ClickHouseè¿æ¥æ± 
4. âœ… å®ç°æ•°æ®æŸ¥è¯¢å’Œç¼“å­˜åŠŸèƒ½
5. âœ… éªŒè¯æ•°æ®åº“æ€§èƒ½å’ŒåŠŸèƒ½

**ä¸‹ä¸€æ­¥ï¼š** ç°åœ¨æ‚¨æœ‰äº†ä¸€ä¸ªé«˜æ€§èƒ½çš„æ—¶åºæ•°æ®åº“ï¼Œå¯ä»¥åœ¨ä¸‹ä¸€èŠ‚å­¦ä¹ å¦‚ä½•ä½¿ç”¨Akshareè·å–Aè‚¡æ•°æ®å¹¶å­˜å‚¨åˆ°ClickHouseä¸­ã€‚

---

## æç¤º

- ä¿æŒClickHouseæœåŠ¡è¿è¡ŒçŠ¶æ€ï¼š`docker-compose up -d`
- å®šæœŸæ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€ï¼šè¿è¡Œæµ‹è¯•è„šæœ¬
- ä½¿ç”¨Redisç¼“å­˜æé«˜æŸ¥è¯¢æ€§èƒ½
- ä¸‹ä¸€æ­¥æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•è·å–çœŸå®çš„Aè‚¡æ•°æ®

---

## æç¤º

- æ¯æ¬¡å¼€å‘å‰ï¼Œè®°å¾—å…ˆæ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼š`source .venv/bin/activate`
- å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥æŸ¥çœ‹æœ¬èŠ‚çš„"å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"éƒ¨åˆ†
- ä¿å­˜å¥½ä½ çš„é¡¹ç›®é…ç½®ï¼Œåç»­ç« èŠ‚ä¼šåœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­å¼€å‘