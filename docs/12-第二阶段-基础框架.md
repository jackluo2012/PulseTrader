# 第二阶段：MVP量化框架（精简版）

> **目标**: 3步跑通最小可行量化系统：数据→策略→回测
> **预计时间**: 1-2小时
> **设计理念**: 先跑通，再优化，拒绝过度设计

## 🚀 核心步骤

### 第1步：数据模块 (30分钟)
```bash
# 创建数据模块
mkdir -p pulse_trader/data
touch pulse_trader/data/__init__.py
touch pulse_trader/data/source.py
```

**pulse_trader/data/source.py**
```python
import tushare as ts
import pandas as pd
import os

class TushareDataSource:
    def __init__(self):
        token = os.getenv('TUSHARE_TOKEN')
        if not token:
            raise ValueError("请设置TUSHARE_TOKEN环境变量")
        ts.set_token(token)
        self.pro = ts.pro_api()

    def get_data(self, symbol: str, start: str, end: str):
        df = self.pro.daily(ts_code=symbol, start_date=start, end_date=end)
        df['trade_date'] = pd.to_datetime(df['trade_date'])
        return df.sort_values('trade_date').set_index('trade_date')[['open','high','low','close','vol']]

    def latest_price(self, symbol: str):
        df = self.get_data(symbol, "20240101", "20241231")
        return df['close'].iloc[-1]
```

### 第2步：策略模块 (30分钟)
```bash
mkdir -p pulse_trader/strategies
touch pulse_trader/strategies/__init__.py
touch pulse_trader/strategies/ma_cross.py
```

**pulse_trader/strategies/ma_cross.py**
```python
import pandas as pd

class MACrossStrategy:
    def __init__(self, fast=5, slow=20):
        self.fast = fast
        self.slow = slow

    def generate_signals(self, data):
        df = data.copy()
        df['ma_fast'] = df['close'].rolling(self.fast).mean()
        df['ma_slow'] = df['close'].rolling(self.slow).mean()
        df['signal'] = 0
        df.loc[df['ma_fast'] > df['ma_slow'], 'signal'] = 1
        df.loc[df['ma_fast'] <= df['ma_slow'], 'signal'] = -1
        return df
```

### 第3步：回测模块 (30分钟)
```bash
mkdir -p pulse_trader/backtest
touch pulse_trader/backtest/__init__.py
touch pulse_trader/backtest/engine.py
```

**pulse_trader/backtest/engine.py**
```python
import pandas as pd

class BacktestEngine:
    def __init__(self, capital=100000):
        self.capital = capital
        self.position = 0
        self.trades = []

    def run(self, data_with_signals):
        for date, row in data_with_signals.iterrows():
            price = row['close']
            signal = row['signal']

            if signal == 1 and self.position == 0:  # 买入
                shares = int(self.capital / price)
                self.position = shares
                self.capital = 0

            elif signal == -1 and self.position > 0:  # 卖出
                self.capital = self.position * price
                self.position = 0

        return self.capital + (self.position * data_with_signals['close'].iloc[-1])

def performance_metrics(final_value, initial_capital, days):
    total_return = (final_value - initial_capital) / initial_capital
    annual_return = (1 + total_return) ** (252 / days) - 1
    return {
        'total_return': total_return,
        'annual_return': annual_return,
        'final_value': final_value
    }
```

## 🧪 集成测试

### 测试脚本
```python
# scripts/mvp_test.py
import sys, os
sys.path.append('.')

# 1. 测试数据获取
from pulse_trader.data.source import TushareDataSource
data_source = TushareDataSource()
data = data_source.get_data("000001.SZ", "20240101", "20240331")
print(f"数据形状: {data.shape}")

# 2. 测试策略
from pulse_trader.strategies.ma_cross import MACrossStrategy
strategy = MACrossStrategy()
signals = strategy.generate_signals(data)
print(f"信号分布: {signals['signal'].value_counts()}")

# 3. 测试回测
from pulse_trader.backtest.engine import BacktestEngine, performance_metrics
engine = BacktestEngine()
final_value = engine.run(signals)
metrics = performance_metrics(final_value, 100000, len(data))

print(f"总收益: {metrics['total_return']:.2%}")
print(f"年化收益: {metrics['annual_return']:.2%}")
print(f"最终价值: {metrics['final_value']:.2f}")
```

### 运行测试
```bash
# 设置Tushare token（需要去tushare.pro注册获取）
export TUSHARE_TOKEN=your_token_here

# 运行测试
python scripts/mvp_test.py
```

## ✅ 成功标准

运行测试后应该看到：
- 数据形状: (60, 5) ✓
- 信号分布: 包含1和-1 ✓
- 总收益显示 ✓
- 年化收益显示 ✓

## 📁 文件结构
```
PulseTrader/
├── pulse_trader/
│   ├── data/__init__.py
│   ├── data/source.py
│   ├── strategies/__init__.py
│   ├── strategies/ma_cross.py
│   ├── backtest/__init__.py
│   └── backtest/engine.py
└── scripts/mvp_test.py
```

**🎯 目标**: 用最少的代码实现一个完整的量化交易流程！

如果测试通过，说明你的MVP框架已经可以运行了！🚀